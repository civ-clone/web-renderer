"use strict";(()=>{var Un=Object.create;var Hi=Object.defineProperty;var Dn=Object.getOwnPropertyDescriptor;var Wn=Object.getOwnPropertyNames;var $n=Object.getPrototypeOf,Nn=Object.prototype.hasOwnProperty;var l=(a,t)=>Hi(a,"name",{value:t,configurable:!0});var jn=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports);var qn=(a,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Wn(t))!Nn.call(a,n)&&n!==e&&Hi(a,n,{get:()=>t[n],enumerable:!(i=Dn(t,n))||i.enumerable});return a};var Bn=(a,t,e)=>(e=a!=null?Un($n(a)):{},qn(t||!a||!a.__esModule?Hi(e,"default",{value:a,enumerable:!0}):e,a));var Xi=(a,t,e)=>{if(!t.has(a))throw TypeError("Cannot "+e)};var r=(a,t,e)=>(Xi(a,t,"read from private field"),e?e.call(a):t.get(a)),m=(a,t,e)=>{if(t.has(a))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(a):t.set(a,e)},h=(a,t,e,i)=>(Xi(a,t,"write to private field"),i?i.call(a,e):t.set(a,e),e);var ln=jn((Hs,Ri)=>{"use strict";var Yn=Object.prototype.hasOwnProperty,z="~";function nt(){}l(nt,"Events");Object.create&&(nt.prototype=Object.create(null),new nt().__proto__||(z=!1));function Kn(a,t,e){this.fn=a,this.context=t,this.once=e||!1}l(Kn,"EE");function an(a,t,e,i,n){if(typeof e!="function")throw new TypeError("The listener must be a function");var s=new Kn(e,i||a,n),o=z?z+t:t;return a._events[o]?a._events[o].fn?a._events[o]=[a._events[o],s]:a._events[o].push(s):(a._events[o]=s,a._eventsCount++),a}l(an,"addListener");function qt(a,t){--a._eventsCount===0?a._events=new nt:delete a._events[t]}l(qt,"clearEvent");function O(){this._events=new nt,this._eventsCount=0}l(O,"EventEmitter");O.prototype.eventNames=l(function(){var t=[],e,i;if(this._eventsCount===0)return t;for(i in e=this._events)Yn.call(e,i)&&t.push(z?i.slice(1):i);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t},"eventNames");O.prototype.listeners=l(function(t){var e=z?z+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var n=0,s=i.length,o=new Array(s);n<s;n++)o[n]=i[n].fn;return o},"listeners");O.prototype.listenerCount=l(function(t){var e=z?z+t:t,i=this._events[e];return i?i.fn?1:i.length:0},"listenerCount");O.prototype.emit=l(function(t,e,i,n,s,o){var u=z?z+t:t;if(!this._events[u])return!1;var c=this._events[u],p=arguments.length,g,f;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),p){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,i),!0;case 4:return c.fn.call(c.context,e,i,n),!0;case 5:return c.fn.call(c.context,e,i,n,s),!0;case 6:return c.fn.call(c.context,e,i,n,s,o),!0}for(f=1,g=new Array(p-1);f<p;f++)g[f-1]=arguments[f];c.fn.apply(c.context,g)}else{var y=c.length,w;for(f=0;f<y;f++)switch(c[f].once&&this.removeListener(t,c[f].fn,void 0,!0),p){case 1:c[f].fn.call(c[f].context);break;case 2:c[f].fn.call(c[f].context,e);break;case 3:c[f].fn.call(c[f].context,e,i);break;case 4:c[f].fn.call(c[f].context,e,i,n);break;default:if(!g)for(w=1,g=new Array(p-1);w<p;w++)g[w-1]=arguments[w];c[f].fn.apply(c[f].context,g)}}return!0},"emit");O.prototype.on=l(function(t,e,i){return an(this,t,e,i,!1)},"on");O.prototype.once=l(function(t,e,i){return an(this,t,e,i,!0)},"once");O.prototype.removeListener=l(function(t,e,i,n){var s=z?z+t:t;if(!this._events[s])return this;if(!e)return qt(this,s),this;var o=this._events[s];if(o.fn)o.fn===e&&(!n||o.once)&&(!i||o.context===i)&&qt(this,s);else{for(var u=0,c=[],p=o.length;u<p;u++)(o[u].fn!==e||n&&!o[u].once||i&&o[u].context!==i)&&c.push(o[u]);c.length?this._events[s]=c.length===1?c[0]:c:qt(this,s)}return this},"removeListener");O.prototype.removeAllListeners=l(function(t){var e;return t?(e=z?z+t:t,this._events[e]&&qt(this,e)):(this._events=new nt,this._eventsCount=0),this},"removeAllListeners");O.prototype.off=O.prototype.removeListener;O.prototype.addListener=O.prototype.on;O.prefixed=z;O.EventEmitter=O;typeof Ri<"u"&&(Ri.exports=O)});var Gn=l(a=>{let t=[],e={},i=[],n="div";return a.replace(/(?!<\\)(["']).+?(?!<\\)(\1)/g,o=>"string$"+(i.push(o.slice(1,-1))-1)).split(/(?=[.#[])/).forEach(o=>{var u;if(!o.match(/^[.#\[]/)){n=o;return}if(o[0]==="."){t.push(o.slice(1));return}if(o[0]==="#"){e.id=o[0].slice(1);return}if(o[0]==="["){let c=o.match(/\[([^=]+)(=(["']?)(.+?)\3)?]/);c!==null&&(e[c[1]]=((u=c[4])!=null?u:"").replace(/string\$(\d+)/,(p,g)=>i[g]));return}}),[n,t,e]},"parseSelector"),v=l(a=>document.createTextNode(a),"t"),d=l((a,...t)=>{let[e,i,n]=Gn(a),s=document.createElement(e);return i.length&&s.classList.add(...i),Fn(s,n),t.length&&s.append(...t),s},"e");var Fn=l((a,t)=>(Object.entries(t).forEach(([e,i])=>a.setAttribute(e,i)),a),"a"),M=l((a,t)=>(Object.entries(t).forEach(([e,i])=>a.addEventListener(e,i)),a),"h");var vt=l(({hierarchy:a,objects:t},e=null)=>{let i=new Map;e&&Object.keys(t).forEach(s=>e.push(s));let n=l(s=>{if(i.has(s))return i.get(s);if(Array.isArray(s)){let o=[];return i.set(s,o),s.forEach(u=>o.push(n(u))),o}if(s&&s["#ref"]){if(e&&e.splice(e.indexOf(s["#ref"]),1),!(s["#ref"]in t))throw new TypeError(`missing ${s["#ref"]}`);let o=n(t[s["#ref"]]);return i.set(s,o),o}if(s instanceof Object){let o={};return i.set(s,o),Object.entries(s).forEach(([u,c])=>{o[u]=n(c)}),o}return s},"getReferences");return n(a)},"reconstituteData");var ve,ie=class{constructor(t=d("div")){m(this,ve,void 0);h(this,ve,t)}build(...t){}element(){return r(this,ve)}empty(){for(;r(this,ve).firstChild!==null;)r(this,ve).firstChild.remove()}};l(ie,"Element"),ve=new WeakMap;var $=ie;var Ge,be,bt=class{constructor(t){m(this,Ge,void 0);m(this,be,void 0);h(this,Ge,t),h(this,be,d("div.action")),r(this,be).addEventListener("keydown",e=>{e.key!=="Escape"&&e.stopPropagation()}),this.build()}activate(){}build(){}complete(){let t=new CustomEvent("actioned",{bubbles:!0,detail:this});r(this,be).dispatchEvent(t)}element(){return r(this,be)}value(){return r(this,Ge).value}};l(bt,"Action"),Ge=new WeakMap,be=new WeakMap;var Y=bt;var Xn=l((a,t)=>d("fieldset",d("legend",v(a)),d(`input[type="range"][max="100"][min="0"][step="1"][value="${t}"]`),d('input[type="number"]'),d("label",d('input[type="checkbox"]'),v("Lock"))),"template"),Fe,N,K,Ie,Xe,yt=class extends ${constructor(e,i){super(Xn(e,i));m(this,Fe,void 0);m(this,N,void 0);m(this,K,void 0);m(this,Ie,void 0);m(this,Xe,[]);h(this,Fe,e),h(this,N,this.element().querySelector('input[type="range"]')),h(this,K,this.element().querySelector('input[type="number"]')),h(this,Ie,this.element().querySelector('input[type="checkbox"]')),this.build()}build(){this.set(r(this,N).value),r(this,N).addEventListener("input",()=>this.set(r(this,N).value)),r(this,K).addEventListener("input",()=>this.set(r(this,K).value)),r(this,Ie).addEventListener("input",()=>this.lock()),this.lock()}label(){return r(this,Fe)}lock(){if(this.isLocked()){r(this,N).setAttribute("disabled",""),r(this,K).setAttribute("disabled","");return}r(this,N).removeAttribute("disabled"),r(this,K).removeAttribute("disabled")}onInput(e){r(this,Xe).push(e)}isLocked(){return r(this,Ie).checked}set(e){e=Math.max(parseInt(e,10),0).toString(),r(this,N).value!==e&&(r(this,N).value=e),r(this,K).value!==e&&(r(this,K).value=e),r(this,Xe).forEach(i=>i())}value(){return parseInt(r(this,N).value,10)}};l(yt,"LockedSlider"),Fe=new WeakMap,N=new WeakMap,K=new WeakMap,Ie=new WeakMap,Xe=new WeakMap;var Vi=yt;var ne,wt=class{constructor(...t){m(this,ne,void 0);h(this,ne,t),r(this,ne).forEach(e=>e.onInput(()=>{if(this.total()===100)return;let i=r(this,ne).filter(s=>s!==e),n=i.filter(s=>!s.isLocked());if(this.total()!==100&&n.length===0){e.set((100-this.total(i)).toString());return}if(this.total()>100){let s=this.total()-100,o=Math.ceil(s/n.length);n.forEach(u=>{u.set((u.value()-Math.min(o,s)).toString()),s-=o}),this.total()>100&&e.set((100-this.total(i)).toString())}if(this.total()<100){let s=100-this.total(),o=Math.ceil(s/n.length);n.forEach(u=>{u.set((u.value()+Math.min(o,s)).toString()),s-=o}),this.total()<100&&e.set((100-this.total(i)).toString())}}))}sliders(){return r(this,ne)}total(t=r(this,ne)){return t.reduce((e,i)=>e+i.value(),0)}};l(wt,"LockedSliderGroup"),ne=new WeakMap;var Yi=wt;var Pe,xt=class extends ie{constructor(e,i=d("div")){super(i);m(this,Pe,void 0);this.element().addEventListener("keydown",n=>{n.stopPropagation()}),this.element().setAttribute("tabindex","0"),h(this,Pe,e)}display(){this.build(),r(this,Pe).append(this.element())}parent(){return r(this,Pe)}};l(xt,"TransientElement"),Pe=new WeakMap;var Ki=xt;var Qi={autoDisplay:!0,canClose:!0,canMaximise:!1,canResize:!1,parent:document.body,position:"auto",size:"auto"},ye,Ve,Se=class extends Ki{constructor(e,i,n={}){var s;super((s=n.parent)!=null?s:Qi.parent,d("div.window"));m(this,ye,void 0);m(this,Ve,void 0);this.options={...Qi,...n},h(this,ye,i),h(this,Ve,e),this.options.size==="auto"&&this.element().classList.add("size-auto"),this.options.size==="maximised"&&this.element().classList.add("maximised"),this.options.size!=="auto"&&["height","width"].forEach(o=>{let u=this.options.size[o];if(typeof u=="number"){this.element().style[o]=u+"px";return}this.element().style[o]=u}),this.options.position==="auto"&&this.element().classList.add("position-auto"),this.options.position!=="auto"&&[["x","left"],["y","top"]].forEach(([o,u])=>{this.element().style[u]=Math.min(0,Math.max(document.body.clientHeight-20,this.options.position[o]))+"px"}),this.options.autoDisplay&&this.display()}build(){this.empty();let e=[[this.options.canMaximise,M(d('button.maximise[aria-label="Maximise"]',v("Maximise"),d('img.maximise[src="../../node_modules/feather-icons/dist/icons/maximize.svg"][alt="Maximise"]'),d('img.restore[src="../../node_modules/feather-icons/dist/icons/minimize.svg"][alt="Restore"]')),{click:()=>this.maximise()})],[this.options.canClose,M(d('button.close[aria-label="Close"]',v("Close"),d('img[src="../../node_modules/feather-icons/dist/icons/x.svg"][alt="Close"]')),{click:()=>this.close()})]].filter(([i])=>i).map(([,i])=>i);this.element().append(M(d("header",d("h3",v(r(this,Ve))),...e),{dblclick:()=>this.maximise()}),d("div.body",r(this,ye)instanceof Node?r(this,ye):d("p",v(r(this,ye))))),this.element().addEventListener("keydown",i=>{i.key==="Escape"&&this.options.canClose&&this.close(),i.stopPropagation()})}close(){this.element().remove(),this.element().dispatchEvent(new CustomEvent("close"))}display(e=!0){super.display(),e&&this.element().focus()}maximise(){!this.options.canMaximise||this.element().classList.toggle("maximised")}update(e){this.element().lastElementChild.remove(),this.element().append(e instanceof Node?e:d("p",v(e)))}};l(Se,"Window"),ye=new WeakMap,Ve=new WeakMap;var ke=Se;var Ye,Et=class extends Y{constructor(){super(...arguments);m(this,Ye,void 0)}activate(){let e=[];new ke("Adjust trade rates",d("div",...this.value().all.map(n=>{let s=new Vi(n._,n.value*100);return e.push(s),s.element()}))).element().addEventListener("close",()=>{transport.send("action",{name:"AdjustTradeRates",id:this.value().id,value:r(this,Ye).sliders().map(n=>[n.label(),parseFloat((n.value()/100).toFixed(2))])})}),h(this,Ye,new Yi(...e))}build(){this.element().append(d('button.adjustTradeRates[title="Adjust trade rates"]'))}value(){return super.value()}};l(Et,"AdjustTradeRates"),Ye=new WeakMap;var Ji=Et;var Ai=[],Ke,Tt=class extends Se{constructor(e,i,n={}){let s={queue:!0,...n};super(e,i,s);m(this,Ke,{});h(this,Ke,s),this.element().classList.add("notificationWindow"),this.element().addEventListener("keydown",o=>{o.key==="Enter"&&(this.close(),o.stopPropagation())})}close(){if(super.close(),r(this,Ke).queue&&Ai.length&&Tt.hasOpenWindow()){let[e,i,n]=Ai.shift();e.display(i),n()}}display(e=!0){return new Promise(i=>{if(Tt.hasOpenWindow()){Ai.push([this,e,i]);return}if(super.display(),!e){i(void 0);return}this.element().focus(),i(void 0)})}static hasOpenWindow(){return!!document.querySelector("div.notificationWindow")}},re=Tt;l(re,"NotificationWindow"),Ke=new WeakMap;var Ct=re;var Qe,Je,se=class extends re{constructor(e,i,n,s="Please choose one of the following:",o={}){o={autoFocus:!0,displayAll:!1,...o,actions:{primary:{label:"OK",action:p=>u(p.selectionList().value)},...o.actions}};let u=l(p=>{this.element().dispatchEvent(new CustomEvent("selection",{detail:p})),this.close(),n(p)},"chooseHandler"),c=M(d("select",...i.map(p=>d(`option[value="${p.value}"]`,v(p.label||p.value)))),{keydown:p=>{p.key==="Enter"&&u(c.value)},dblclick:()=>u(c.value)});o.displayAll&&i.length>1&&c.setAttribute("size",i.length.toString()),o.autoFocus&&c.setAttribute("autofocus","");super(e,d("div",...s instanceof Node?[s]:s===null?[]:[d("p",v(s))],c,d("footer",...Object.entries(o.actions).map(([,{label:p,action:g}])=>M(d("button",v(p)),{click:()=>g(this),keydown:f=>{f.key==="Enter"&&g(this)}})))));m(this,Qe,l(()=>this.resize(),"#resizeHandler"));m(this,Je,void 0);this.element().classList.add("selectionWindow"),h(this,Je,c),this.resize(),window.addEventListener("resize",r(this,Qe))}close(){window.removeEventListener("resize",r(this,Qe)),super.close()}display(){return super.display(!1).then(()=>{let e=this.element().querySelector("select");e&&e.hasAttribute("autofocus")&&e.focus()})}resize(){var e,i;try{this.selectionList().style.maxHeight="none",this.selectionList().style.maxHeight=`calc(${this.element().offsetHeight-3-this.element().firstElementChild.offsetHeight-((i=(e=this.selectionList().previousElementSibling)==null?void 0:e.offsetHeight)!=null?i:0)-this.selectionList().nextElementSibling.offsetHeight}px - 2em)`}catch(n){console.warn(n)}}selectionList(){return r(this,Je)}};l(se,"SelectionWindow"),Qe=new WeakMap,Je=new WeakMap;var oe=se;var Lt=class extends Y{activate(){let t=new oe("Choose research",this.value().available.map(e=>({value:e._})),e=>{!e||(transport.send("action",{name:"ChooseResearch",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which advance would you like to research next?",{displayAll:!0})}build(){this.element().append(d('button.chooseResearch[title="Choose research"]'))}value(){return super.value()}};l(Lt,"ChooseResearch");var Zi=Lt;var Mt={Food:"Food",UnitSupportFood:"Food",PopulationSupportFood:"Food",Production:"Production",UnitSupportProduction:"Production",Trade:"Trade",Corruption:"Trade",Happiness:"Happiness",LuxuryHappiness:"Happiness",Unhappiness:"Unhappiness",MartialLawContent:"Unhappiness",MilitaryUnhappiness:"Unhappiness",PopulationUnhappiness:"Unhappiness",CityImprovementContent:"Unhappiness",Research:"Research",Luxuries:"Luxuries",Gold:"Gold",CityImprovementMaintenanceGold:"Gold"},ae=Object.entries(Mt).reduce((a,[t,e])=>(Object.prototype.hasOwnProperty.call(a,e)||(a[e]=[]),a[e].push(t),a),{}),en={Food:"city/food.png",Production:"city/production.png",Trade:"city/trade.png",Gold:"city/gold.png",Luxuries:"city/luxury.png",Pollution:"city/pollution.png",Research:"city/bulb.png",Unhappiness:"city/sad.png"};var tn,nn=l(a=>tn=a,"setPreloadContainer"),_i=l(a=>{let t=tn.querySelector(`[src$="${a}.png"]`);return t===null?(console.error(`Missing image: ${a}.`),d("canvas")):t},"getPreloadedImage"),Oi=_i;var Vn=l((a,t,e)=>{let i=d("canvas"),n=i.getContext("2d");i.width=a.width,i.height=a.height,n.drawImage(a,0,0,a.width,a.height);let s=n.getImageData(0,0,i.width,i.height),o=l(p=>{var y;let g=null,f={r:0,g:0,b:0,a:0};return typeof p=="string"?(g=p.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i))!==null?f={r:parseInt(g[1],16),g:parseInt(g[2],16),b:parseInt(g[3],16),a:1}:(g=p.match(/^#([0-9a-fA-F])([0-9a-fA-F])([0-9a-fA-F])$/))!==null?f={r:parseInt(g[1]+g[1],16),g:parseInt(g[2]+g[2],16),b:parseInt(g[3]+g[3],16),a:1}:(g=p.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/))!==null?f={r:parseInt(g[1]),g:parseInt(g[2]),b:parseInt(g[3]),a:1}:(g=p.match(/^rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+|\d+\.|\.\d+|\d+\.\d+)\s*\)\s*$/))!==null&&(f={r:parseInt(g[1]),g:parseInt(g[2]),b:parseInt(g[3]),a:parseFloat((y=g[4])!=null?y:1)}):"length"in p&&(f={r:p[0]||0,g:p[1]||0,b:p[2]||0,a:p[3]||1}),f},"getColor"),u=t.map(o),c=e.map(o);for(let p=0;p<s.data.length;p+=4)u.forEach((g,f)=>{s.data[p]===g.r&&s.data[p+1]===g.g&&s.data[p+2]===g.b&&s.data[p+3]===g.a*255&&(s.data[p]=(c[f]||c[0]).r,s.data[p+1]=(c[f]||c[0]).g,s.data[p+2]=(c[f]||c[0]).b,s.data[p+3]=Math.trunc((c[f]||c[0]).a*255))});return n.putImageData(s,0,0),i},"replaceColours"),It=Vn;var le,we,Ze,de,et,ue,j=class{constructor(t,e=2,i=16,n=d("canvas")){m(this,le,void 0);m(this,we,void 0);m(this,Ze,!0);m(this,de,void 0);m(this,et,void 0);m(this,ue,void 0);h(this,le,n),h(this,ue,t),h(this,et,i),h(this,de,e),this.setCanvasSize(),h(this,we,r(this,le).getContext("2d")),nn(document.querySelector("#preload"))}canvas(){return r(this,le)}clear(){this.context().clearRect(0,0,this.canvas().width,this.canvas().height)}context(){return r(this,we)}render(t=this.world().tiles()){this.clear(),t.forEach(({x:e,y:i})=>this.renderTile(this.world().get(e,i)))}renderTile({x:t,y:e}){let i=this.tileSize(),n=t*i,s=e*i;this.context().clearRect(n,s,i,i)}scale(){return r(this,de)}tileSize(){return r(this,et)*r(this,de)}update(t){t.forEach(({x:e,y:i})=>this.renderTile(this.world().get(e,i)))}world(){return r(this,ue)}drawImage(t,e,i,n={}){var p,g;let s=this.tileSize(),o=e*s,u=i*s,c=this.getPreloadedImage(t);this.putImage(n.augment?n.augment(c):c,o+((p=n.offsetX)!=null?p:0),u+((g=n.offsetY)!=null?g:0))}filterNeighbours(t,e,i=["n","e","s","w"]){return i.filter(n=>e(r(this,ue).getNeighbour(t,n)))}getPreloadedImage(t){return _i(t)}putImage(t,e,i){r(this,we).imageSmoothingEnabled=!1,r(this,we).drawImage(t,e,i,t.width*r(this,de),t.height*r(this,de))}replaceColours(t,e,i){return It(t,e,i)}setCanvasSize(){r(this,le).height=r(this,ue).height()*this.tileSize(),r(this,le).width=r(this,ue).width()*this.tileSize()}isVisible(){return r(this,Ze)}setVisible(t){h(this,Ze,t)}};l(j,"Map"),le=new WeakMap,we=new WeakMap,Ze=new WeakMap,de=new WeakMap,et=new WeakMap,ue=new WeakMap;var rn=j;var Pt=class extends j{renderTile(t){super.renderTile(t);let{x:e,y:i}=t,n=this.tileSize(),s=e*n,o=i*n;if(t.city){let u=t.city,c=u.player,p=c.civilization,[g]=p.attributes.filter(f=>f.name==="colors");t.units.length>0&&(this.context().fillStyle="#000",this.context().fillRect(s,o,n,n)),this.context().fillStyle=g.value[0],this.context().fillRect(s+this.scale(),o+this.scale(),n-this.scale()*2,n-this.scale()*2),this.drawImage("map/city",e,i,{augment:f=>this.replaceColours(f,["#000"],[g.value[1]]),offsetX:this.scale(),offsetY:this.scale()})}}};l(Pt,"Cities");var tt=Pt;var St=class extends re{constructor(t,e,i,n={}){var o,u;let s=M(d("button",v((o=n.okLabel)!=null?o:"OK")),{click:()=>{i(),this.close()},keydown:c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),c.stopPropagation(),i(),this.close())}});super(t,d("div.content",d("p",v(e)),d("footer",s,M(d("button",v((u=n.cancelLabel)!=null?u:"Cancel")),{click:()=>this.close(),keydown:c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),c.stopPropagation(),this.close())}}))),{...n,queue:!1}),s.focus()}};l(St,"ConfirmationWindow");var sn=St;var He,Ae,kt=class{constructor(t,e){m(this,He,void 0);m(this,Ae,[]);this.setIds(t),h(this,He,i=>{let{detail:n}=i,s=n.value.objects;!s||r(this,Ae).some(o=>o in s)&&document.addEventListener("dataupdated",o=>e(o.detail.data),{once:!0})}),document.addEventListener("patchdatareceived",r(this,He))}dispose(){document.removeEventListener("patchdatareceived",r(this,He))}setIds(t){r(this,Ae).splice(0,r(this,Ae).length,...t)}};l(kt,"DataObserver"),He=new WeakMap,Ae=new WeakMap;var on=kt;var Ht=class extends j{update(t){let e=[...t];return t.forEach(i=>{["n","ne","e","se","s","sw","w","nw"].forEach(n=>{let s=this.world().getNeighbour(i,n);e.includes(s)||e.push(s)})}),super.update(e)}};l(Ht,"TerrainAbstract");var D=Ht;var At=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t;t.terrain.features.length&&t.terrain.features.forEach(n=>n._==="Shield"?this.drawImage(`terrain/${n._.toLowerCase()}`,e,i,{offsetX:4*this.scale(),offsetY:4*this.scale()}):this.drawImage(`terrain/${n._.toLowerCase()}`,e,i))}};l(At,"Feature");var _t=At;var Ot=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t;this.filterNeighbours(t,n=>n.terrain._==="Unknown").forEach(n=>this.drawImage(`map/fog_${n}`,e,i))}};l(Ot,"Fog");var Rt=Ot;var zt=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t,n=t.improvements.reduce((s,o)=>{let u=o._;return u in s&&(s[u]=!0),s},{Mine:!1,Road:!1,Railroad:!1,Pollution:!1});if(["Mine","Pollution"].forEach(s=>{n[s]&&this.drawImage(`improvements/${s.toLowerCase()}`,e,i)}),n.Road){let s=this.filterNeighbours(t,u=>u.improvements.some(c=>c._==="Road"),["n","ne","e","se","s","sw","w","nw"]),o=this.filterNeighbours(t,u=>!!u.city||u.improvements.some(c=>c._==="Railroad"),["n","ne","e","se","s","sw","w","nw"]);if(s.forEach(u=>{(!n.Railroad||!o.includes(u))&&this.drawImage(`improvements/road_${u}`,e,i)}),n.Railroad&&o.forEach(u=>this.drawImage(`improvements/railroad_${u}`,e,i)),s.length===0&&o.length===0){let u=this.tileSize(),c=e*u,p=i*u,g=Math.floor(this.tileSize()/2)-this.scale();this.context().fillStyle=n.Railroad?"#000":"#8c5828",this.context().rect(c+g,p+g,this.scale()*2,this.scale()*2),this.context().fill()}}}};l(zt,"Terrain");var Ut=zt;var Dt=class extends oe{constructor(t,e=()=>{}){super("Activate unit",t.map(i=>{var n,s;return{label:i._+" ["+((s=(n=i.city)==null?void 0:n.name)!=null?s:"NONE")+"]"+(i.busy?` (${i.busy._})`:""),value:i.id}}),i=>{let[n]=t.filter(s=>s.id===i);if(!!n){if(!n.active){transport.send("action",{name:"InactiveUnit",id:i});return}e(n)}},null)}};l(Dt,"InactiveUnitSelectionWindow");var Wt=Dt;var $t=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t;!t.improvements.some(s=>s._==="Irrigation")||this.drawImage("improvements/irrigation",e,i)}};l($t,"Terrain");var Nt=$t;var jt=class extends D{renderTile(t){super.renderTile(t);let{x:e,y:i}=t,n=this.tileSize(),s=e*n,o=i*n;if(t.terrain._!=="Unknown"){if(t.isLand)this.drawImage("terrain/land",e,i);else if(t.isWater&&(this.drawImage("terrain/ocean",e,i),t.isCoast)){let u=this.getPreloadedImage("terrain/coast_sprite"),c=(this.world().getNeighbour(t,"w").isLand?1:0)|(this.world().getNeighbour(t,"nw").isLand?2:0)|(this.world().getNeighbour(t,"n").isLand?4:0)|(this.world().getNeighbour(t,"ne").isLand?8:0)|(this.world().getNeighbour(t,"e").isLand?16:0)|(this.world().getNeighbour(t,"se").isLand?32:0)|(this.world().getNeighbour(t,"s").isLand?64:0)|(this.world().getNeighbour(t,"sw").isLand?128:0);if(c>0){let p=c&7,g=c>>2&7,f=c>>4&7,y=c>>6&7|(c&1)<<2,w=d('canvas[height="16"][width="16"]'),S=w.getContext("2d");S.drawImage(u,p<<4,0,8,8,0,0,8,8),S.drawImage(u,(g<<4)+8,0,8,8,8,0,8,8),S.drawImage(u,(f<<4)+8,8,8,8,8,8,8,8),S.drawImage(u,y<<4,8,8,8,0,8,8,8),this.putImage(w,s,o)}this.filterNeighbours(t,p=>p.terrain._==="River").forEach(p=>this.drawImage(`terrain/river_mouth_${p}`,e,i))}}}};l(jt,"Land");var it=jt;var dn=Bn(ln());var Qn={playerId:null,scale:2,tileSize:16},H,R,xe,q,rt,J,Ee,I,Bt=class extends dn.EventEmitter{constructor(e,i=d("canvas"),n={playerId:null,scale:2},...s){let o={...Qn,...n};super();m(this,H,void 0);m(this,R,{x:0,y:0});m(this,xe,void 0);m(this,q,[]);m(this,rt,null);m(this,J,void 0);m(this,Ee,void 0);m(this,I,void 0);h(this,I,e),h(this,H,i),h(this,rt,o.playerId),h(this,Ee,o.tileSize),h(this,J,o.scale),s.forEach(u=>r(this,q).push(new u(r(this,I),this.scale(),this.tileSize()))),h(this,xe,i.getContext("2d")),this.bindEvents()}bindEvents(){}build(e){r(this,q).forEach(i=>i.update(e))}canvas(){return r(this,H)}center(){return r(this,R)}getLayer(e){var i;return(i=this.getLayers(e).shift())!=null?i:null}getLayers(e){return r(this,q).filter(i=>i instanceof e)}isVisible(e,i){let n=Math.floor(r(this,H).width/r(this,Ee)),s=Math.floor(r(this,H).height/r(this,Ee));if(n>=r(this,I).width()&&s>=r(this,I).height())return!0;let[o,u,c,p]=this.visibleBounds();return(n>=r(this,I).width()||(o>u?e<u||e>o:e<u&&e>o))&&(s>=r(this,I).height()||(c>p?i<p||i>c:i<p&&i>c))}playerId(){return r(this,rt)}render(){let e=r(this,q)[0].tileSize(),i=r(this,I).width()*e,n=r(this,R).x*e+Math.trunc(e/this.scale()),s=Math.trunc(r(this,H).width/2),o=r(this,I).height()*e,u=r(this,R).y*e+Math.trunc(e/this.scale()),c=Math.trunc(r(this,H).height/2),p=s-n,g=s+i,f=c-u,y=c+o;for(;p>0;)p-=i;for(;f>0;)f-=o;for(;g<r(this,H).width;)g+=i;for(;y<r(this,H).height;)y+=o;r(this,xe).fillStyle="#000",r(this,xe).fillRect(0,0,Math.max(r(this,I).width()*e,r(this,H).width),Math.max(r(this,I).height()*e,r(this,H).height));for(let w=p;w<g;w+=i)for(let S=f;S<y;S+=o)r(this,q).forEach(Me=>{if(!Me.isVisible())return;let X=Me.canvas();r(this,xe).drawImage(X,w,S,X.width,X.height)})}scale(){return r(this,J)}setCenter(e,i){r(this,R).x=e,r(this,R).y=i,this.render(),this.emit("focus-changed",e,i)}tileSize(){return r(this,Ee)}visibleBounds(){let e=Math.floor(r(this,H).width/r(this,q)[0].tileSize()/r(this,J)),i=Math.floor(r(this,H).height/r(this,q)[0].tileSize()/r(this,J)),n=(r(this,R).x-e+r(this,I).width())%r(this,I).width(),s=(r(this,R).x+e)%r(this,I).width(),o=(r(this,R).y-i+r(this,I).height())%r(this,I).height(),u=(r(this,R).y+i)%r(this,I).height();return[n,s,o,u]}visibleRange(){let e=Math.floor(r(this,H).width/r(this,q)[0].tileSize()/r(this,J)),i=Math.floor(r(this,H).height/r(this,q)[0].tileSize()/r(this,J));return[{x:r(this,R).x-e,y:r(this,R).y-i},{x:r(this,R).x+e,y:r(this,R).y+i}]}world(){return r(this,I)}};l(Bt,"Portal"),H=new WeakMap,R=new WeakMap,xe=new WeakMap,q=new WeakMap,rt=new WeakMap,J=new WeakMap,Ee=new WeakMap,I=new WeakMap;var Gt=Bt;var Ft=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t,n=this.filterNeighbours(t,s=>t.terrain._==="River"&&s.isWater||t.terrain._===s.terrain._).join("");t.terrain._!=="Ocean"&&(n?this.drawImage(`terrain/${t.terrain._.toLowerCase()}_${n}`,e,i):this.drawImage(`terrain/${t.terrain._.toLowerCase()}`,e,i))}};l(Ft,"Terrain");var Xt=Ft;var Yt,_e,ce,pe,me,Vt=class{constructor(t){m(this,Yt,l((t,e)=>({_:"Tile",id:`Tile-${t}--${e}`,city:null,goodyHut:null,improvements:[],isCoast:!1,isLand:!1,isWater:!1,terrain:{_:"Unknown",id:`UnknownTerrain-${t}--${e}`,features:[]},units:[],x:t,y:e,yields:[]}),"#unknown"));m(this,_e,{});m(this,ce,void 0);m(this,pe,void 0);m(this,me,void 0);h(this,pe,t.height),h(this,me,t.width),h(this,ce,t.tiles||[])}get(t,e){for(;t<0;)t+=r(this,me);for(;e<0;)e+=r(this,pe);for(;t>=r(this,me);)t-=r(this,me);for(;e>=r(this,pe);)e-=r(this,pe);let i=[t,e].toString();if(!(i in r(this,_e))){let n=r(this,ce).findIndex(s=>s.x===t&&s.y===e);if(n===-1)return r(this,Yt).call(this,t,e);r(this,_e)[i]=n}return r(this,ce)[r(this,_e)[i]]}getNeighbour(t,e){if(e==="n")return this.get(t.x,t.y-1);if(e==="ne")return this.get(t.x+1,t.y-1);if(e==="e")return this.get(t.x+1,t.y);if(e==="se")return this.get(t.x+1,t.y+1);if(e==="s")return this.get(t.x,t.y+1);if(e==="sw")return this.get(t.x-1,t.y+1);if(e==="w")return this.get(t.x-1,t.y);if(e==="nw")return this.get(t.x-1,t.y-1);throw new TypeError("Invalid direction.")}height(){return r(this,pe)}tiles(){return r(this,ce)}width(){return r(this,me)}setTiles(t){h(this,ce,t)}};l(Vt,"World"),Yt=new WeakMap,_e=new WeakMap,ce=new WeakMap,pe=new WeakMap,me=new WeakMap;var Kt=Vt;var Qt=class extends rn{renderTile(t){super.renderTile(t);let{x:e,y:i}=t,n=this.tileSize(),s=e*n,o=i*n,u=t.yields.reduce((f,y)=>f+y.value,0),c=t.yields.sort((f,y)=>f._.charCodeAt(0)-y._.charCodeAt(0)),p=0;if(u<5){let f=[[s,o],[s+n/2,o],[s,o+n/2],[s+n/2,o+n/2]];c.forEach(y=>{for(let w=0;w<y.value;w++)this.putImage(this.getPreloadedImage(`city/${y._.toLowerCase()}`),...f[p++])});return}if(u<7){let f=[[s,o],[s+n/3,o],[s+n/3*2,o],[s,o+n/2],[s+n/3,o+n/2],[s+n/3*2,o+n/2]];c.forEach(y=>{for(let w=0;w<y.value;w++)this.putImage(this.getPreloadedImage(`city/${y._.toLowerCase()}`),f[p][0],f[p++][1])});return}if(u<9){let f=[[s,o],[s+n/4,o],[s+n/4*2,o],[s+n/4*3,o],[s,o+n/2],[s+n/4,o+n/2],[s+n/4*2,o+n/2],[s+n/4*3,o+n/2]];c.forEach(y=>{for(let w=0;w<y.value;w++)this.putImage(this.getPreloadedImage(`city/${y._.toLowerCase()}`),...f[p++])});return}if(u<11){let f=[[s,o],[s+n/5,o],[s+n/5*2,o],[s+n/5*3,o],[s+n/5*4,o],[s,o+n/2],[s+n/5,o+n/2],[s+n/5*2,o+n/2],[s+n/5*3,o+n/2],[s+n/5*4,o+n/2]];c.forEach(y=>{for(let w=0;w<y.value;w++)this.putImage(this.getPreloadedImage(`city/${y._.toLowerCase()}`),...f[p++])});return}let g=[[s,o],[s+n/6,o],[s+n/6*2,o],[s+n/6*3,o],[s+n/6*4,o],[s+n/6*5,o],[s,o+n/2],[s+n/6,o+n/2],[s+n/6*2,o+n/2],[s+n/6*3,o+n/2],[s+n/6*4,o+n/2],[s+n/6*5,o+n/2]];c.forEach(f=>{for(let y=0;y<f.value;y++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[p++])})}};l(Qt,"Yields");var Oe=Qt;var Jn={BuildingIrrigation:"I",BuildingMine:"M",BuildingRoad:"R",BuildingRailroad:"RR"},Zn=l((a,t=16)=>{var u,c;let e=a.player,i=e.civilization,[n]=i.attributes.filter(p=>p.name==="colors"),s=It(Oi(`units/${a._.toLowerCase()}`),["#60E064","#2C7800"],n.value),o=s.getContext("2d");if(o.imageSmoothingEnabled=!1,(u=a.improvements)!=null&&u.some(p=>p._==="Fortified")&&o.drawImage(Oi("map/fortify"),0,0),a.busy){let p=t/2,g=t*.75,f=(c=Jn[a.busy._])!=null?c:a.busy._.replace(/[a-z]+/g,"");o.font="bold 8px sans-serif",o.fillStyle="black",o.textAlign="center",o.fillText(f,p,g),o.fillStyle="white",o.fillText(f,p,g)}return s},"renderUnit"),Jt=Zn;var st,Zt=class extends ${constructor(e,i=2){super(d('canvas[width="32"][height="32"]'));m(this,st,2);h(this,st,i),this.build(e)}build(e){let i=Jt(e),n=this.element().getContext("2d");n.imageSmoothingEnabled=!1;let s=this.size(i.width),o=this.size(i.height),u=Math.floor((this.size(16)-s)/2),c=Math.floor((this.size(16)-o)/2);n.drawImage(i,u,c,s,o)}element(){return super.element()}size(e=16){return e*r(this,st)}};l(Zt,"Unit"),st=new WeakMap;var zi=Zt;var er=l(a=>Math.max(1,Math.ceil((a.build.cost.value-a.build.progress.value)/a.yields.filter(t=>ae.Production.includes(t._)).reduce((t,e)=>t+e.value,0))),"buildTurns"),tr=l(a=>Math.max(1,Math.ceil((a.growth.cost.value-a.growth.progress.value)/a.yields.filter(t=>ae.Food.includes(t._)).reduce((t,e)=>t+e.value,0))),"growthTurns"),ir=l(a=>{let t=a.growth,e=parseInt(a.name.replace(/[^a-z]/gi,""),36).toString(2),[i,n]=a.yields.reduce(([u,c],p)=>(ae.Happiness.includes(p._)&&(u+=p.value),ae.Unhappiness.includes(p._)&&(c+=p.value),[u,c]),[0,0]),s=new Array(t.size).fill(1),o=s.length-1;for(;n>0&&o>-1;)s[o--]=0,n--;for(o=0;i>0&&o<s.length;)s[o]===0&&(s[o]++,i--),s[o]===1&&(s[o++]++,i--),s[o]===2&&o++;return d("div.population",...s.map((u,c)=>d("span.citizen",d(`img[src="view/assets/city/people_${["unhappy","content","happy"][u]}_${["f","m"][parseInt(e[c%e.length],10)]}.png"]`))))},"renderPopulation"),nr=l((a,t)=>t.filter(e=>ae[a].includes(e._)).reduce(([e,i],n)=>[e+(n.value<0?-n.value:0),i+n.value],[0,0]),"reduceYield"),rr=l(a=>d("div.yields-detail",...[["Food"],["Production"],["Trade"],["Luxuries","Gold","Research"]].map(t=>d(`div.yields[data-yields="${t.join(" ")}"]`,...t.map(e=>d(`span.yield[data-yield="${e}"]`,...nr(e,a.yields).map((i,n)=>d(`span.${["used","free"][n]}`,...Ui({id:"",_:e,value:i,values:[]}))))))),...Object.entries(a.yields.filter(t=>!Object.keys(Mt).includes(t._)).reduce((t,e)=>(e._ in t||(t[e._]=0),t[e._]+=e.value,t),{})).map(([t,e])=>d("div",d("div",v(t)),d("div",v(e))))),"renderYields"),sr=l((a,t)=>{let e=d("canvas"),i=new Gt(new Kt(t.player.world),e,{playerId:t.player.id,scale:a.scale(),tileSize:a.tileSize()},it,Nt,Xt,Ut,_t,Rt,tt,Oe);return e.height=a.tileSize()*a.scale()*5,e.width=a.tileSize()*a.scale()*5,i.setCenter(t.tile.x,t.tile.y),i.build(t.tiles),i.getLayer(Oe).render(t.tilesWorked),i.render(),M(d("div.city-map",e),{click:()=>transport.send("action",{name:"ReassignWorkers",city:t.id})})},"renderMap"),Ui=l(a=>new Array(Math.abs(a.value)).fill(0).map(()=>d("span.yield-icon",d(`img[src="view/assets/${en[Mt[a._]]}"]`))),"yieldImages"),or=l((a,t,e)=>{let i=er(a);return d("div.build",d("header",v(`Building ${a.build.building?a.build.building.item._:"nothing"}`)),M(d("button",v(a.build.building?"Change":"Choose")),{click(){t()}}),M(d("button",v("Buy")),{click(){e()}}),a.build.building?d("p",v(`Progress ${a.build.progress.value} / ${a.build.cost.value} (${i} turn${i===1?"":"s"})`)):v(""))},"renderBuildDetails"),ar=l(a=>{let t=a.growth,e=tr(a);return d("div.growth",d("header",v("Growth")),d("p",v(`Size ${t.size.toString()}`)),d("p",v(`Progress ${a.build.progress.value} / ${a.build.cost.value} (${e} turn${e===1?"":"s"})`)))},"renderGrowth"),lr=l(a=>d("div.improvements",d("div",...a.improvements.map(t=>d("div",v(t._),...a.yields.filter(e=>e._==="CityImprovementMaintenanceGold").filter(e=>e.cityImprovement.id===t.id).flatMap(e=>Ui(e)))))),"renderImprovements"),dr=l(a=>M(d("div.garrisoned-units",d("header",v("Garrisoned Units")),d("div.units",...a.tile.units.map(t=>new zi(t).element()))),{click(){let t=a.tile.units.filter(e=>e.player.id===a.player.id);t.length!==0&&new Wt(t)}}),"renderGarrisonedUnits"),ur=l(a=>d("div.supported-units",d("header",v("Supported Units")),d("div.units",...a.units.map(t=>d("span.unit",new zi(t).element(),...a.yields.filter(e=>["UnitSupportFood","UnitSupportProduction","MilitaryUnhappiness"].includes(e._)).filter(e=>e.unit.id===t.id).flatMap(e=>Ui(e)))))),"renderSupportedUnits"),un=l((a,t,e,i)=>d("div.city-screen",d("div.top-row",d("div.yield-details",ir(a),rr(a),ur(a)),sr(t,a),lr(a)),d("div.bottom-row",ar(a),d("div.tabbed-details",d("div.info",dr(a))),or(a,e,i))),"buildDetails"),Z,Re,ot,ei=class extends ke{constructor(e,i){super(e.name,un(e,i,()=>this.changeProduction(),()=>this.completeProduction()),{size:"maximised"});m(this,Z,void 0);m(this,Re,void 0);m(this,ot,void 0);this.element().classList.add("city-screen-window"),h(this,Z,e),h(this,ot,i),h(this,Re,new on([e.id,e.build.id,e.growth.id,...e.units.map(n=>n.id)],n=>{var o,u;let[s]=((u=(o=n.player)==null?void 0:o.cities)!=null?u:[]).filter(c=>e.id===c.id);if(!s){this.close();return}h(this,Z,s),r(this,Re).setIds([s.id,s.build.id,s.growth.id,...s.units.map(c=>c.id)]),this.update(un(s,r(this,ot),()=>this.changeProduction(),()=>this.completeProduction())),this.element().focus()})),this.element().addEventListener("keydown",n=>{["c","C"].includes(n.key)&&(this.changeProduction(),n.preventDefault(),n.stopPropagation()),["b","B"].includes(n.key)&&(this.completeProduction(),n.preventDefault(),n.stopPropagation()),["Enter","x","X"].includes(n.key)&&this.close()})}changeProduction(){new ze(r(this,Z).build,()=>this.element().focus())}close(){r(this,Re).dispose(),super.close()}completeProduction(){!r(this,Z).build.building||new sn("Are you sure?",`Do you want to rush building of ${r(this,Z).build.building.item._}`,()=>transport.send("action",{name:"CompleteProduction",id:r(this,Z).id}))}};l(ei,"City"),Z=new WeakMap,Re=new WeakMap,ot=new WeakMap;var ti=ei;var Ue=class extends se{constructor(e,i=()=>{},n={}){let s=e.city.yields.filter(u=>u._==="Production").reduce((u,c)=>u+c.value,0),o=l(u=>Math.ceil((u.cost.value-e.progress.value)/s),"turns");super(`What would you like to build in ${e.city.name}?`,e.available.map(u=>({label:`${u.item._} (Cost: ${u.cost.value} / ${o(u)} turn${o(u)===1?"":"s"})`,value:u.item._})),u=>{!u||(transport.send("action",{name:e.building===null?"CityBuild":"ChangeProduction",id:e.id,chosen:u||"@"}),this.close(!0))},null,{actions:n,displayAll:!0});this.onComplete=i}close(e=!1){super.close(),e&&this.onComplete(e)}};l(Ue,"CityBuildSelectionWindow"),Ue.showCityAction=l((e,i)=>({label:"View city",action(n){n.close(),new ti(e,i)}}),"showCityAction"),Ue.showCityOnMapAction=l((e,i)=>({label:"Show on map",action(n){n.close(),i.setCenter(e.tile.x,e.tile.y)}}),"showCityOnMapAction");var ze=Ue;var De,ii=class extends Y{constructor(e,i){super(e);m(this,De,void 0);h(this,De,i)}activate(){new ze(this.value(),()=>this.complete(),{showCity:ze.showCityAction(this.value().city,r(this,De)),showCityOnMap:ze.showCityOnMapAction(this.value().city,r(this,De))})}build(){let e=this.value();this.element().append(d(`button.cityBuild[title="What would you like to build in ${e.city.name}?"]`))}value(){return super.value()}};l(ii,"CityBuild"),De=new WeakMap;var cn=ii;var ni=class extends Y{activate(){transport.send("action",{name:"EndTurn"})}build(){this.element().append(d('button.endTurn[title="End turn"]'))}};l(ni,"EndTurn");var pn=ni;var ri=class extends Y{activate(){let t=new oe("Choose government",this.value().available.map(e=>({value:e._})),e=>{!e||(transport.send("action",{name:"Revolution",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which government would you like to convert to?",{displayAll:!0})}build(){this.element().append(d('button.chooseGovernment[title="Choose government"]'))}value(){return super.value()}};l(ri,"Revolution");var mn=ri;var at,si=class extends ie{constructor(e=d("div.actions"),i){super(e);m(this,at,void 0);h(this,at,i),this.element().addEventListener("actioned",n=>n.detail.element().remove()),this.element().addEventListener("keydown",n=>{var g;let s=document.activeElement;if(!this.element().contains(s))return;let{key:o}=n,u=Array.from(this.element().children);if(!["ArrowDown","ArrowLeft","ArrowRight","ArrowUp"].includes(o)||u.length===0)return;n.preventDefault(),n.stopPropagation();let c=s===this.element()?["ArrowLeft","ArrowUp"].includes(o)?s.firstElementChild:s.lastElementChild:s;for(;c.parentElement!==this.element();)c=c.parentElement;let p=u.indexOf(c);if(["ArrowUp","ArrowLeft"].includes(o)){if(p>0){(g=u[p-1].querySelector("button"))==null||g.focus();return}u.pop().querySelector("button").focus();return}if(["ArrowDown","ArrowRight"].includes(o)){if(p<u.length-1){u[p+1].querySelector("button").focus();return}u.shift().querySelector("button").focus();return}},!0)}build(e){this.empty(),e.forEach(i=>{let n;switch(i._){case"ActiveUnit":return;case"AdjustTradeRates":n=new Ji(i);break;case"ChooseResearch":n=new Zi(i);break;case"CityBuild":n=new cn(i,r(this,at));break;case"EndTurn":n=new pn(i);break;case"Revolution":n=new mn(i);break;default:console.log("need to handle "+i._);return}this.element().prepend(M(n.element(),{click:()=>n.activate(),keydown:({key:s})=>{(s===" "||s==="Enter")&&n.activate()}}))})}};l(si,"Actions"),at=new WeakMap;var Di=si;var Te,oi=class extends j{constructor(){super(...arguments);m(this,Te,null)}renderTile(e){super.renderTile(e);let{x:i,y:n}=e,s=this.tileSize(),o=i*s,u=n*s;if(e.units.length>0&&(r(this,Te)!==null?r(this,Te).tile.id!==e.id:!0)){let[c]=e.units.sort((g,f)=>{var y,w;return((y=f.defence)==null?void 0:y.value)-((w=g.defence)==null?void 0:w.value)}),p=this.renderUnit(c);e.units.length>1&&this.putImage(p,o-this.scale(),u-this.scale()),this.putImage(p,o,u)}}renderUnit(e){return Jt(e)}setActiveUnit(e){h(this,Te,e)}activeUnit(){return r(this,Te)}};l(oi,"Units"),Te=new WeakMap;var lt=oi;var ai=class extends lt{render(){this.clear();let t=this.activeUnit();if(t===null)return;let{x:e,y:i}=t.tile,n=this.world().get(e,i),s=this.tileSize(),o=e*s,u=i*s,c=this.renderUnit(t);n.units.length>1&&this.putImage(c,o-this.scale(),u-this.scale()),this.putImage(c,o,u)}update(){this.render()}};l(ai,"ActiveUnit");var Wi=ai;var li=class extends j{renderTile(t){if(!t.city)return;super.renderTile(t);let{x:e,y:i}=t,n=this.tileSize(),s=e*n,o=i*n,u=t.city,c=this.tileSize()/2,p=this.tileSize()*.75,g=this.tileSize()/2,f=this.tileSize()*1.6;this.context().font=`bold ${8*this.scale()}px sans-serif`,this.context().fillStyle="black",this.context().textAlign="center",this.context().fillText(u.growth.size.toString(),s+c+this.scale(),o+p),this.context().fillText(u.name,s+g+this.scale(),o+f),this.context().fillStyle="white",this.context().fillText(u.growth.size.toString(),s+c,o+p-this.scale()),this.context().fillText(u.name,s+g,o+f-this.scale())}update(){this.clear(),this.world().tiles().filter(t=>!!t.city).forEach(t=>this.renderTile(t))}};l(li,"CityNames");var $i=li;var dt,ut,di=class extends ${constructor(e,i,n){super(e);m(this,dt,void 0);m(this,ut,void 0);h(this,dt,i),h(this,ut,n)}build(){this.empty(),this.element().append(d("h3",d("span#year",v(this.year())),d("span#turn",v(`(${r(this,dt).value.toString()})`))))}year(e=r(this,ut).value){return e<0?Math.abs(e)+" BCE":e===0?"1 CE":e+" CE"}};l(di,"GameDetails"),dt=new WeakMap,ut=new WeakMap;var hn=di;var ui=class extends Gt{bindEvents(){this.canvas().addEventListener("click",t=>{let e=this.center(),i=t.offsetX,n=t.offsetY;for(i=(i-(this.canvas().width/2-this.tileSize()))/(this.tileSize()*this.scale())+e.x,n=(n-(this.canvas().height/2-this.tileSize()))/(this.tileSize()*this.scale())+e.y;i<0;)i+=this.world().width();for(;n<0;)n+=this.world().height();for(;i>this.world().width();)i-=this.world().width();for(;n>this.world().height();)n-=this.world().height();let s=this.world().get(Math.trunc(i),Math.trunc(n)),o=s.units.filter(u=>u.player.id===this.playerId());if(s.city)new ti(s.city,this);else if(o.length){new Wt(o,u=>this.emit("activate-unit",u));return}this.setCenter(s.x,s.y)})}};l(ui,"GamePortal");var fn=ui;var ci=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t;t.goodyHut!==null&&this.drawImage("map/hut",e,i)}};l(ci,"Terrain");var gn=ci;var Ce,he,pi=class{constructor(t=500){m(this,Ce,!1);m(this,he,[]);setInterval(()=>this.check(),t)}check(){r(this,Ce)||r(this,he).forEach(t=>t())}clear(){h(this,he,[])}off(t){h(this,he,r(this,he).filter(e=>e!==t))}on(t){r(this,he).push(t)}pause(){h(this,Ce,!0)}isPaused(){return r(this,Ce)}resume(){h(this,Ce,!1)}};l(pi,"IntervalHandler"),Ce=new WeakMap,he=new WeakMap;var vn=pi;var mi=class extends se{constructor(t,e,i,n="Please choose one of the following:",s={autoDisplay:!1,canClose:!1,displayAll:!1}){super(t,e,i,n,{...s,autoDisplay:!1,displayAll:!0})}display(){return new Promise(t=>{this.element().addEventListener("selection",({detail:e})=>t(e)),super.display()})}};l(mi,"MandatorySelection");var bn=mi;var ct,hi=class{constructor(t){m(this,ct,void 0);h(this,ct,t)}channel(){return r(this,ct)}};l(hi,"Request"),ct=new WeakMap;var fi=hi;var gi=class extends fi{constructor(){super("getOptions")}};l(gi,"Options");var yn=gi;var vi=class extends ${constructor(t){super(t),this.build();let e=document.querySelector('#preload img[src$="main-menu-bg.jpg"]');e.loading?e.addEventListener("load",()=>{t.classList.add("active")}):t.classList.add("active")}build(t=!1){this.element().append(M(d("nav",M(d("button[autofocus]",v("Start a New Game")),{click:()=>{this.disableButtons(),[()=>new bn("How many players?",[{label:"7 civilizations",value:7},{label:"6 civilizations",value:6},{label:"5 civilizations",value:5},{label:"4 civilizations",value:4},{label:"3 civilizations",value:3}],i=>transport.send("setOption",{name:"players",value:i})).display()].reduce((e,i)=>e.then(()=>i()),Promise.resolve()).then(()=>{this.remove(),transport.send("start")})}}),M(d("button",v("Customise World")),{click:async()=>{var f,y,w,S,Me,X;this.disableButtons();let e=await transport.request(new yn,["players","height","width","landCoverage","landSize","maxIterations"]),i=d(`input[name="players"][type="number"][value="${(f=e.players)!=null?f:7}"][step="1"][min="1"][max="20"]`),n=d(`input[name="height"][type="number"][value="${(y=e.height)!=null?y:60}"][step="1"][min="1"]`),s=d(`input[name="width"][type="number"][value="${(w=e.width)!=null?w:80}"][step="1"][min="1"]`),o=d(`input[name="landCoverage"][type="number"][value="${(S=e.landCoverage)!=null?S:.4}"][step="0.01"][min="0"]`),u=d(`input[name="landSize"][type="number"][value="${(Me=e.landSize)!=null?Me:.2}"][step="0.01"][min="0"]`),c=d(`input[name="maxIterations"][type="number"][value="${(X=e.maxIterations)!=null?X:20}"][step="1"][min="1"]`),p=l(async()=>{g.close(),await transport.request(new fi("setOptions"),{players:i.value,height:n.value,width:s.value,landCoverage:o.value,landSize:u.value,maxIterations:c.value}),this.remove(),transport.send("start")},"submit"),g=new ke("Customise world",d("div.customise-world",d("div.option",d("label",v("Players")),i),d("div.option",d("label",v("Height")),n),d("div.option",d("label",v("Width")),s),d("div.option",d("label",v("Land coverage")),o),d("div.option",d("label",v("Land size")),u),d("div.option",d("label",v("Max iterations")),c),M(d("button",v("Build")),{click:()=>p()})));g.element().addEventListener("keydown",Ne=>{Ne.key==="Enter"&&p()})}}),M(d("button"+(t?"":"[hidden]"),v("Quit")),{click:()=>{this.remove(),transport.send("quit")}})),{keydown(e){let i=document.activeElement;i===null||!i.matches("#mainmenu nav button")||(e.key==="ArrowDown"&&i.nextElementSibling&&i.nextElementSibling.focus(),e.key==="ArrowUp"&&i.previousElementSibling&&i.previousElementSibling.focus())}}))}disableButtons(){this.element().querySelectorAll("button").forEach(t=>t.setAttribute("disabled",""))}remove(){this.element().classList.remove("active"),setTimeout(()=>{this.element().remove()},2e3)}};l(vi,"MainMenu");var wn=vi;var B,F,Le,We,Q,bi=class{constructor(t,e,i,...n){m(this,B,void 0);m(this,F,void 0);m(this,Le,void 0);m(this,We,void 0);m(this,Q,void 0);h(this,F,t),h(this,Q,e),h(this,We,i),h(this,Le,n),h(this,B,r(this,F).getContext("2d")),r(this,F).addEventListener("click",s=>{let o=s.offsetX-r(this,F).offsetLeft,u=s.offsetY-r(this,F).offsetTop,c=Math.ceil(o/r(this,F).offsetWidth*r(this,Q).width()),p=Math.ceil(u/r(this,F).offsetHeight*r(this,Q).height());r(this,We).setCenter(c,p),this.update()})}update(){let t=r(this,Le)[0].canvas().height*(190/r(this,Le)[0].canvas().width);r(this,F).height=t,r(this,B).clearRect(0,0,190,t),r(this,Le).forEach(n=>r(this,B).drawImage(n.canvas(),0,0,190,t));let[e,i]=r(this,We).visibleRange();r(this,B).lineWidth=1,r(this,B).strokeStyle="#fff",r(this,B).fillStyle="rgba(255, 255, 255, .2)",r(this,B).rect(Math.floor(190/r(this,Q).width()*e.x),Math.floor(t/r(this,Q).height()*e.y),Math.floor(190/r(this,Q).width()*(i.x-e.x)),Math.floor(t/r(this,Q).height()*(i.y-e.y))),r(this,B).stroke(),r(this,B).fill()}};l(bi,"Minimap"),B=new WeakMap,F=new WeakMap,Le=new WeakMap,We=new WeakMap,Q=new WeakMap;var xn=bi;var pt,$e,yi=class{constructor(t=document.body){m(this,pt,void 0);m(this,$e,[]);h(this,pt,t)}receive(t){r(this,$e).push(t),this.check()}check(){let t=document.querySelector(".notificationWindow");if(!r(this,$e).length||t)return;let e=r(this,$e).shift();this.publish(e)}publish(t){var i;new Ct((i=t.title)!=null?i:"Notification",t.message,{parent:r(this,pt)}).element().addEventListener("close",()=>this.check())}};l(yi,"Notifications"),pt=new WeakMap,$e=new WeakMap;var En=yi;var mt,wi=class extends ${constructor(e,i){super(e);m(this,mt,void 0);h(this,mt,i)}build(){this.empty();let{civilization:e,treasury:i,research:n,cities:s}=r(this,mt),[o,u]=s.reduce(([p,g],f)=>f.yields.reduce(([y,w],S)=>S._==="Research"?[y,w+S.value]:ae.Gold.includes(S._)?[y+S.value,w]:[y,w],[p,g]),[0,0]),c=Math.ceil((n.cost.value-n.progress.value)/u);this.element().append(d("h3",v(`${e.leader.name} of the ${e._} empire`)),d("p",d("strong",v("Researching")),d("br"),v(n.researching?`${n.researching._} ${n.progress.value} / ${n.cost.value} (${c} turn${c===1?"":"s"})`:"Nothing")),d("p",d("strong",v("Treasury")),d("br"),v(`${i.value} (${o} / turn)`)))}};l(wi,"PlayerDetails"),mt=new WeakMap;var Tn=wi;var L,xi=class extends ${constructor(e,i){super(e);m(this,L,void 0);h(this,L,i),this.build()}build(){var e,i;this.empty(),r(this,L)!==null&&this.element().append(d("p",v(`${r(this,L)._} (${r(this,L).tile.x}, ${r(this,L).tile.y})`)),d("p",v((i=(e=r(this,L).city)==null?void 0:e.name)!=null?i:"NONE")),d("p",v(`${Number.isInteger(r(this,L).moves.value)?r(this,L).moves.value:r(this,L).moves.value.toFixed(2)} / ${r(this,L).movement.value} moves`)),d("p",v(`A: ${r(this,L).attack.value} / D: ${r(this,L).defence.value} / V: ${r(this,L).visibility.value}`)),d("p",v(`${r(this,L).improvements.map(n=>n._).join(", ")}`)),d("p",v(`${r(this,L).tile.terrain._}${r(this,L).tile.terrain.features?" "+r(this,L).tile.terrain.features.map(n=>n._).join(", "):""}${r(this,L).tile.improvements.length?" ("+r(this,L).tile.improvements.map(n=>n._).join(", ")+")":""}`)),d("p",v(`${r(this,L).tile.units.filter(n=>n!==r(this,L)).map(n=>n._).join(", ")}`)))}};l(xi,"UnitDetails"),L=new WeakMap;var Cn=xi;var ht,Ei=class{constructor(t){m(this,ht,void 0);h(this,ht,t)}init(){let t=r(this,ht);window.transport=t;let e={autoEndOfTurn:!0};try{let i=document.getElementById("notification"),n=document.querySelector("#mainmenu"),s=document.getElementById("actions"),o=document.getElementById("other-actions"),u=document.getElementById("game"),c=document.getElementById("map"),p=c.querySelector("canvas"),g=document.getElementById("gameDetails"),f=document.getElementById("playerDetails"),y=document.getElementById("minimap"),w=document.getElementById("unitInfo"),S=new En,Me=new wn(n),X=l((T,A,ee,ge)=>{let V=new Cn(w,T);if(G=T,V.build(),ee.setActiveUnit(T),ee.render(),ee.setVisible(!0),ge.setActiveUnit(T),ge.render(),ge.setVisible(!0),T===null){A.render();return}W=T,ee.update([...W!=null&&W.tile?[W.tile]:[],T.tile]),A.isVisible(T.tile.x,T.tile.y)||A.setCenter(T.tile.x,T.tile.y),A.render()},"setActiveUnit"),Ne=[],ft,W=null,G=null;t.receive("notification",T=>{i.innerHTML=T,ft&&window.clearTimeout(ft),ft=window.setTimeout(()=>{ft=void 0,i.innerText=""},4e3)}),[["chooseCivilization","Choose your civilization"],["chooseLeader","Choose your leader"]].forEach(([T,A])=>t.receive(T,ee=>{let{choices:ge}=vt(ee);new oe(A,ge.map(({_:V})=>({label:V,value:V})),V=>t.send(T,V),A,{displayAll:!0})})),t.receiveOnce("gameData",T=>{try{let A=vt(T),ee=new Intl.ListFormat;new Ct("Welcome",d("div.welcome",d("p",v(`${A.player.civilization.leader.name}, you have risen to become leader of the ${A.player.civilization._}.`)),d("p",v(`Your people have knowledge of ${ee.format(["Irrigation","Mining","Roads",...A.player.research.complete.map(b=>b._)])}`)))),u.classList.add("active"),p.width=p.parentElement.offsetWidth,p.height=p.parentElement.offsetHeight;let ge=2,V=new Kt(A.player.world),gt=[],Pn=new vn,C=new fn(V,p,{playerId:A.player.id,scale:ge,tileSize:16},it,Nt,Xt,Ut,_t,gn,Rt,Oe,lt,tt,$i,Wi),Sn=C.getLayer(it),Li=C.getLayer(Oe),je=C.getLayer(lt),Mi=C.getLayer(tt),Ni=C.getLayer($i),qe=C.getLayer(Wi);Li.setVisible(!1);let Ii=new xn(y,V,C,Sn,Mi),ji=new Di(s,C),kn=new Di(o,C);C.on("focus-changed",()=>Ii.update()),C.on("activate-unit",b=>X(b,C,je,qe)),Pn.on(()=>{qe.setVisible(!qe.isVisible()),C.build(Ne.splice(0)),C.render()}),window.addEventListener("resize",()=>{p.width=p.parentElement.offsetWidth,p.height=p.parentElement.offsetHeight});let qi=1,Pi=!1,Si=l(b=>{let E=Pi?[]:null,x=vt(b,E);E&&((k=>{for(let Be=0,Rn=Math.ceil(k.length/1e3);Be<Rn;Be++)setTimeout(()=>k.slice(Be*1e3,(Be+1)*1e3-1).forEach(zn=>delete b.objects[zn]),(Be+1)*200)})(E),Pi=!1),document.dispatchEvent(new CustomEvent("dataupdated",{detail:{data:x}})),qi!==x.turn.value&&(Pi=!0,qi=x.turn.value),ji.build(x.player.mandatoryActions),kn.build(x.player.actions.filter(k=>["AdjustTradeRates","Revolution"].includes(k._))),u.append(ji.element()),V.setTiles(x.player.world.tiles),new hn(g,x.turn,x.year).build(),new Tn(f,x.player).build(),gt=x.player.actions.filter(k=>k._==="ActiveUnit");let[_]=gt.sort(({value:k},{value:te})=>te===W?1:k===W?-1:(C.isVisible(te.tile.x,te.tile.y)?1:0)-(C.isVisible(k.tile.x,k.tile.y)?1:0));if(W!==(_==null?void 0:_.value)&&(W=null),X(W!=null&&W.active?W:_?_.value:null,C,je,qe),C.build(Ne.splice(0)),C.render(),Ii.update(),e.autoEndOfTurn&&x.player.mandatoryActions.length===1&&x.player.mandatoryActions.every(k=>k._==="EndTurn")){t.send("action",{name:"EndTurn"});return}},"handler");Si(T),t.receive("gameData",b=>Si(b));let Hn=l(b=>b.replace(/]/g,"").split(/[.[]/),"pathToParts"),Bi=l((b,E)=>{let x=Hn(E),P=x.pop();return[x.reduce((_,k)=>!_||!(k in _)?null:_[k],b),P]},"getPenultimateObject"),An=l((b,E,x)=>{let[P,U]=Bi(b,E);if(!P||!U){console.warn(`unable to set ${E} of ${b} (${U})`);return}P[U]=x},"setObjectPath"),_n=l((b,E)=>{let[x,P]=Bi(b,E);if(!x||!P){console.warn(`unable to set ${E} of ${b} (${P})`);return}delete x[P]},"removeObjectPath");t.receive("gameDataPatch",b=>{b.forEach(E=>Object.entries(E).forEach(([x,{type:P,index:U,value:_}])=>{if(P==="add"||P==="update"){if(!_.hierarchy){console.error("No hierarchy"),console.error(_);return}U?An(T.objects[x],U,_.hierarchy):T.objects[x]=_.hierarchy,document.dispatchEvent(new CustomEvent("patchdatareceived",{detail:{value:_}})),Object.entries(_.objects).forEach(([k,te])=>{T.objects[k]=te,te._==="PlayerTile"&&Ne.push(te)})}if(P==="remove"){if(U){_n(T.objects[x],U);return}delete T.objects[x]}})),Si(T)}),t.receive("gameNotification",b=>S.receive(b));let Gi={" ":["NoOrders"],b:["FoundCity"],D:["Disband"],f:["Fortify","BuildFortress"],i:["BuildIrrigation","ClearForest","ClearSwamp","ClearJungle"],m:["BuildMine","PlantForest"],P:["Pillage"],r:["BuildRoad","BuildRailroad"],s:["Sleep"],u:["Unload"],w:["Wait"]},ki={ArrowUp:"n",PageUp:"ne",ArrowRight:"e",PageDown:"se",ArrowDown:"s",End:"sw",ArrowLeft:"w",Home:"nw"},On={8:"n",9:"ne",6:"e",3:"se",2:"s",1:"sw",4:"w",7:"nw"},pr={[KeyboardEvent.DOM_KEY_LOCATION_STANDARD]:ki,[KeyboardEvent.DOM_KEY_LOCATION_NUMPAD]:On},Fi="";document.addEventListener("keydown",b=>{if(G){if(b.key in Gi){let E=[...Gi[b.key]];for(;E.length;){let x=E.shift(),[P]=G.actions.filter(U=>U._===x);if(P){t.send("action",{name:"ActiveUnit",id:G.id,unitAction:P._,target:P.to.id}),b.stopPropagation(),b.preventDefault();return}}}if(b.key in ki){let[E]=G.actionsForNeighbours[ki[b.key]];if(E){t.send("action",{name:"ActiveUnit",id:G.id,unitAction:E._,target:E.to.id}),b.stopPropagation(),b.preventDefault();return}}}if(b.key==="Escape"&&document.activeElement!==null){document.activeElement.blur();return}if(b.key==="Enter"&&A.player.mandatoryActions.some(E=>E._==="EndOfTurn")){t.send("action",{name:"EndTurn"}),b.stopPropagation(),b.preventDefault();return}if(b.key==="Tab"){let E=s.querySelector("div.action:first-child button");if(E!==null){E.focus(),b.preventDefault(),b.stopPropagation();return}}if(b.key==="c"&&G){C.setCenter(G.tile.x,G.tile.y),C.render(),Ii.update();return}if(b.key==="w"&&G&&gt.length>1){let E=gt.map(U=>U.value),x=E.indexOf(G),P=E[x===E.length-1?0:x+1];X(P,C,je,qe)}if(b.key==="t"){je.setVisible(!je.isVisible()),Mi.setVisible(!Mi.isVisible()),Ni.setVisible(!Ni.isVisible()),C.render();return}if(b.key==="y"){Li.setVisible(!Li.isVisible()),C.render();return}if(Fi==="%"&&b.key==="^"){t.send("cheat",{name:"RevealMap"});return}Fi=b.key})}catch(A){console.error(A)}})}catch(i){console.error(i)}}};l(Ei,"Renderer"),ht=new WeakMap;var Ln=Ei;var Ti=class{async request(t,...e){return new Promise(i=>{this.send(t.channel(),...e),this.receiveOnce(t.channel(),n=>i(n))})}};l(Ti,"AbstractTransport");var Mn=Ti;var fe,Ci=class extends Mn{constructor(e){super();m(this,fe,void 0);h(this,fe,e)}receive(e,i){r(this,fe).addEventListener("message",({data:{channel:n,data:s}})=>{n===e&&i(s)})}receiveOnce(e,i){let n=l(({data:{channel:s,data:o}})=>{s===e&&(i(o),r(this,fe).removeEventListener("message",n))},"onceHandler");r(this,fe).addEventListener("message",n)}send(e,i){r(this,fe).postMessage({channel:e,data:i})}};l(Ci,"WorkerTransport"),fe=new WeakMap;var In=Ci;var cr=new Ln(new In(new Worker("view/js/backend.js")));cr.init();})();
//# sourceMappingURL=frontend.js.map
