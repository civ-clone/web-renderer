"use strict";(()=>{var Sr=Object.create;var Mi=Object.defineProperty;var kr=Object.getOwnPropertyDescriptor;var Hr=Object.getOwnPropertyNames;var _r=Object.getPrototypeOf,Ar=Object.prototype.hasOwnProperty;var l=(a,t)=>Mi(a,"name",{value:t,configurable:!0});var Or=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports);var Ur=(a,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Hr(t))!Ar.call(a,r)&&r!==e&&Mi(a,r,{get:()=>t[r],enumerable:!(i=kr(t,r))||i.enumerable});return a};var zr=(a,t,e)=>(e=a!=null?Sr(_r(a)):{},Ur(t||!a||!a.__esModule?Mi(e,"default",{value:a,enumerable:!0}):e,a));var ji=(a,t,e)=>{if(!t.has(a))throw TypeError("Cannot "+e)};var o=(a,t,e)=>(ji(a,t,"read from private field"),e?e.call(a):t.get(a)),m=(a,t,e)=>{if(t.has(a))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(a):t.set(a,e)},h=(a,t,e,i)=>(ji(a,t,"write to private field"),i?i.call(a,e):t.set(a,e),e);var ir=Or((Lo,ki)=>{"use strict";var Rr=Object.prototype.hasOwnProperty,U="~";function Ze(){}l(Ze,"Events");Object.create&&(Ze.prototype=Object.create(null),new Ze().__proto__||(U=!1));function jr(a,t,e){this.fn=a,this.context=t,this.once=e||!1}l(jr,"EE");function tr(a,t,e,i,r){if(typeof e!="function")throw new TypeError("The listener must be a function");var n=new jr(e,i||a,r),s=U?U+t:t;return a._events[s]?a._events[s].fn?a._events[s]=[a._events[s],n]:a._events[s].push(n):(a._events[s]=n,a._eventsCount++),a}l(tr,"addListener");function Nt(a,t){--a._eventsCount===0?a._events=new Ze:delete a._events[t]}l(Nt,"clearEvent");function H(){this._events=new Ze,this._eventsCount=0}l(H,"EventEmitter");H.prototype.eventNames=l(function(){var t=[],e,i;if(this._eventsCount===0)return t;for(i in e=this._events)Rr.call(e,i)&&t.push(U?i.slice(1):i);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t},"eventNames");H.prototype.listeners=l(function(t){var e=U?U+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var r=0,n=i.length,s=new Array(n);r<n;r++)s[r]=i[r].fn;return s},"listeners");H.prototype.listenerCount=l(function(t){var e=U?U+t:t,i=this._events[e];return i?i.fn?1:i.length:0},"listenerCount");H.prototype.emit=l(function(t,e,i,r,n,s){var d=U?U+t:t;if(!this._events[d])return!1;var c=this._events[d],p=arguments.length,g,f;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),p){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,i),!0;case 4:return c.fn.call(c.context,e,i,r),!0;case 5:return c.fn.call(c.context,e,i,r,n),!0;case 6:return c.fn.call(c.context,e,i,r,n,s),!0}for(f=1,g=new Array(p-1);f<p;f++)g[f-1]=arguments[f];c.fn.apply(c.context,g)}else{var y=c.length,w;for(f=0;f<y;f++)switch(c[f].once&&this.removeListener(t,c[f].fn,void 0,!0),p){case 1:c[f].fn.call(c[f].context);break;case 2:c[f].fn.call(c[f].context,e);break;case 3:c[f].fn.call(c[f].context,e,i);break;case 4:c[f].fn.call(c[f].context,e,i,r);break;default:if(!g)for(w=1,g=new Array(p-1);w<p;w++)g[w-1]=arguments[w];c[f].fn.apply(c[f].context,g)}}return!0},"emit");H.prototype.on=l(function(t,e,i){return tr(this,t,e,i,!1)},"on");H.prototype.once=l(function(t,e,i){return tr(this,t,e,i,!0)},"once");H.prototype.removeListener=l(function(t,e,i,r){var n=U?U+t:t;if(!this._events[n])return this;if(!e)return Nt(this,n),this;var s=this._events[n];if(s.fn)s.fn===e&&(!r||s.once)&&(!i||s.context===i)&&Nt(this,n);else{for(var d=0,c=[],p=s.length;d<p;d++)(s[d].fn!==e||r&&!s[d].once||i&&s[d].context!==i)&&c.push(s[d]);c.length?this._events[n]=c.length===1?c[0]:c:Nt(this,n)}return this},"removeListener");H.prototype.removeAllListeners=l(function(t){var e;return t?(e=U?U+t:t,this._events[e]&&Nt(this,e)):(this._events=new Ze,this._eventsCount=0),this},"removeAllListeners");H.prototype.off=H.prototype.removeListener;H.prototype.addListener=H.prototype.on;H.prefixed=U;H.EventEmitter=H;typeof ki<"u"&&(ki.exports=H)});var Dr=l(a=>{let t=[],e={},i=[],r="div";return a.replace(/(?!<\\)(["']).+?(?!<\\)(\1)/g,s=>"string$"+(i.push(s.slice(1,-1))-1)).split(/(?=[.#[])/).forEach(s=>{var d;if(!s.match(/^[.#\[]/)){r=s;return}if(s[0]==="."){t.push(s.slice(1));return}if(s[0]==="#"){e.id=s[0].slice(1);return}if(s[0]==="["){let c=s.match(/\[([^=]+)(=(["']?)(.+?)\3)?]/);c!==null&&(e[c[1]]=((d=c[4])!=null?d:"").replace(/string\$(\d+)/,(p,g)=>i[g]));return}}),[r,t,e]},"parseSelector"),v=l(a=>document.createTextNode(a),"t"),u=l((a,...t)=>{let[e,i,r]=Dr(a),n=document.createElement(e);return i.length&&n.classList.add(...i),Wr(n,r),t.length&&n.append(...t),n},"e");var Wr=l((a,t)=>(Object.entries(t).forEach(([e,i])=>a.setAttribute(e,i)),a),"a"),M=l((a,t)=>(Object.entries(t).forEach(([e,i])=>a.addEventListener(e,i)),a),"h");var mt=l(({hierarchy:a,objects:t},e=null)=>{let i=new Map;e&&Object.keys(t).forEach(n=>e.push(n));let r=l(n=>{if(i.has(n))return i.get(n);if(Array.isArray(n)){let s=[];return i.set(n,s),n.forEach(d=>s.push(r(d))),s}if(n&&n["#ref"]){if(e&&e.splice(e.indexOf(n["#ref"]),1),!(n["#ref"]in t))throw new TypeError(`missing ${n["#ref"]}`);let s=r(t[n["#ref"]]);return i.set(n,s),s}if(n instanceof Object){let s={};return i.set(n,s),Object.entries(n).forEach(([d,c])=>{s[d]=r(c)}),s}return n},"getReferences");return r(a)},"reconstituteData");var ve,te=class{constructor(t=u("div")){m(this,ve,void 0);h(this,ve,t)}build(...t){}element(){return o(this,ve)}empty(){for(;o(this,ve).firstChild!==null;)o(this,ve).firstChild.remove()}};l(te,"Element"),ve=new WeakMap;var N=te;var Re,be,ht=class{constructor(t){m(this,Re,void 0);m(this,be,void 0);h(this,Re,t),h(this,be,u("div.action")),o(this,be).addEventListener("keydown",e=>{e.key!=="Escape"&&e.stopPropagation()}),this.build()}activate(){}build(){}complete(){let t=new CustomEvent("actioned",{bubbles:!0,detail:this});o(this,be).dispatchEvent(t)}element(){return o(this,be)}value(){return o(this,Re).value}};l(ht,"Action"),Re=new WeakMap,be=new WeakMap;var V=ht;var $r=l((a,t)=>u("fieldset",u("legend",v(a)),u(`input[type="range"][max="100"][min="0"][step="1"][value="${t}"]`),u('input[type="number"]'),u("label",u('input[type="checkbox"]'),v("Lock"))),"template"),je,R,q,Le,Be,ft=class extends N{constructor(e,i){super($r(e,i));m(this,je,void 0);m(this,R,void 0);m(this,q,void 0);m(this,Le,void 0);m(this,Be,[]);h(this,je,e),h(this,R,this.element().querySelector('input[type="range"]')),h(this,q,this.element().querySelector('input[type="number"]')),h(this,Le,this.element().querySelector('input[type="checkbox"]')),this.build()}build(){this.set(o(this,R).value),o(this,R).addEventListener("input",()=>this.set(o(this,R).value)),o(this,q).addEventListener("input",()=>this.set(o(this,q).value)),o(this,Le).addEventListener("input",()=>this.lock()),this.lock()}label(){return o(this,je)}lock(){if(this.isLocked()){o(this,R).setAttribute("disabled",""),o(this,q).setAttribute("disabled","");return}o(this,R).removeAttribute("disabled"),o(this,q).removeAttribute("disabled")}onInput(e){o(this,Be).push(e)}isLocked(){return o(this,Le).checked}set(e){e=Math.max(parseInt(e,10),0).toString(),o(this,R).value!==e&&(o(this,R).value=e),o(this,q).value!==e&&(o(this,q).value=e),o(this,Be).forEach(i=>i())}value(){return parseInt(o(this,R).value,10)}};l(ft,"LockedSlider"),je=new WeakMap,R=new WeakMap,q=new WeakMap,Le=new WeakMap,Be=new WeakMap;var Bi=ft;var ie,gt=class{constructor(...t){m(this,ie,void 0);h(this,ie,t),o(this,ie).forEach(e=>e.onInput(()=>{if(this.total()===100)return;let i=o(this,ie).filter(n=>n!==e),r=i.filter(n=>!n.isLocked());if(this.total()!==100&&r.length===0){e.set((100-this.total(i)).toString());return}if(this.total()>100){let n=this.total()-100,s=Math.ceil(n/r.length);r.forEach(d=>{d.set((d.value()-Math.min(s,n)).toString()),n-=s}),this.total()>100&&e.set((100-this.total(i)).toString())}if(this.total()<100){let n=100-this.total(),s=Math.ceil(n/r.length);r.forEach(d=>{d.set((d.value()+Math.min(s,n)).toString()),n-=s}),this.total()<100&&e.set((100-this.total(i)).toString())}}))}sliders(){return o(this,ie)}total(t=o(this,ie)){return t.reduce((e,i)=>e+i.value(),0)}};l(gt,"LockedSliderGroup"),ie=new WeakMap;var Gi=gt;var Me,vt=class extends te{constructor(e,i=u("div")){super(i);m(this,Me,void 0);this.element().addEventListener("keydown",r=>{r.stopPropagation()}),this.element().setAttribute("tabindex","0"),h(this,Me,e)}display(){this.build(),o(this,Me).append(this.element())}parent(){return o(this,Me)}};l(vt,"TransientElement"),Me=new WeakMap;var Fi=vt;var Xi={autoDisplay:!0,canClose:!0,canMaximise:!1,canResize:!1,parent:document.body,position:"auto",size:"auto"},ye,Ge,Ie=class extends Fi{constructor(e,i,r={}){var n;super((n=r.parent)!=null?n:Xi.parent,u("div.window"));m(this,ye,void 0);m(this,Ge,void 0);this.options={...Xi,...r},h(this,ye,i),h(this,Ge,e),this.options.size==="auto"&&this.element().classList.add("size-auto"),this.options.size==="maximised"&&this.element().classList.add("maximised"),this.options.size!=="auto"&&["height","width"].forEach(s=>{let d=this.options.size[s];if(typeof d=="number"){this.element().style[s]=d+"px";return}this.element().style[s]=d}),this.options.position==="auto"&&this.element().classList.add("position-auto"),this.options.position!=="auto"&&[["x","left"],["y","top"]].forEach(([s,d])=>{this.element().style[d]=Math.min(0,Math.max(document.body.clientHeight-20,this.options.position[s]))+"px"}),this.options.autoDisplay&&this.display()}build(){this.empty();let e=[[this.options.canMaximise,M(u('button.maximise[aria-label="Maximise"]',v("Maximise"),u('img.maximise[src="../../node_modules/feather-icons/dist/icons/maximize.svg"][alt="Maximise"]'),u('img.restore[src="../../node_modules/feather-icons/dist/icons/minimize.svg"][alt="Restore"]')),{click:()=>this.maximise()})],[this.options.canClose,M(u('button.close[aria-label="Close"]',v("Close"),u('img[src="../../node_modules/feather-icons/dist/icons/x.svg"][alt="Close"]')),{click:()=>this.close()})]].filter(([i])=>i).map(([,i])=>i);this.element().append(M(u("header",u("h3",v(o(this,Ge))),...e),{dblclick:()=>this.maximise()}),u("div.body",o(this,ye)instanceof Node?o(this,ye):u("p",v(o(this,ye))))),this.element().addEventListener("keydown",i=>{i.key==="Escape"&&this.options.canClose&&this.close(),i.stopPropagation()})}close(){this.element().remove(),this.element().dispatchEvent(new CustomEvent("close"))}display(e=!0){super.display(),e&&this.element().focus()}maximise(){!this.options.canMaximise||this.element().classList.toggle("maximised")}update(e){this.element().lastElementChild.remove(),this.element().append(e instanceof Node?e:u("p",v(e)))}};l(Ie,"Window"),ye=new WeakMap,Ge=new WeakMap;var bt=Ie;var Fe,yt=class extends V{constructor(){super(...arguments);m(this,Fe,void 0)}activate(){let e=[];new bt("Adjust trade rates",u("div",...this.value().all.map(r=>{let n=new Bi(r._,r.value*100);return e.push(n),n.element()}))).element().addEventListener("close",()=>{transport.send("action",{name:"AdjustTradeRates",id:this.value().id,value:o(this,Fe).sliders().map(r=>[r.label(),parseFloat((r.value()/100).toFixed(2))])})}),h(this,Fe,new Gi(...e))}build(){this.element().append(u('button.adjustTradeRates[title="Adjust trade rates"]'))}value(){return super.value()}};l(yt,"AdjustTradeRates"),Fe=new WeakMap;var Yi=yt;var Ii=[],Xe,wt=class extends Ie{constructor(e,i,r={}){let n={queue:!0,...r};super(e,i,n);m(this,Xe,{});h(this,Xe,n),this.element().classList.add("notificationWindow"),this.element().addEventListener("keydown",s=>{s.key==="Enter"&&(this.close(),s.stopPropagation())})}close(){if(super.close(),o(this,Xe).queue&&Ii.length&&wt.hasOpenWindow()){let[e,i,r]=Ii.shift();e.display(i),r()}}display(e=!0){return new Promise(i=>{if(wt.hasOpenWindow()){Ii.push([this,e,i]);return}if(super.display(),!e){i(void 0);return}this.element().focus(),i(void 0)})}static hasOpenWindow(){return!!document.querySelector("div.notificationWindow")}},re=wt;l(re,"NotificationWindow"),Xe=new WeakMap;var xt=re;var Ye,Ve,ne=class extends re{constructor(e,i,r,n="Please choose one of the following:",s={}){s={autoFocus:!0,displayAll:!1,...s,actions:{primary:{label:"OK",action:p=>d(p.selectionList().value)},...s.actions}};let d=l(p=>{this.element().dispatchEvent(new CustomEvent("selection",{detail:p})),this.close(),r(p)},"chooseHandler"),c=M(u("select",...i.map(p=>u(`option[value="${p.value}"]`,v(p.label||p.value)))),{keydown:p=>{p.key==="Enter"&&d(c.value)},dblclick:()=>d(c.value)});s.displayAll&&i.length>1&&c.setAttribute("size",i.length.toString()),s.autoFocus&&c.setAttribute("autofocus","");super(e,u("div",...n instanceof Node?[n]:n===null?[]:[u("p",v(n))],c,u("footer",...Object.entries(s.actions).map(([,{label:p,action:g}])=>M(u("button",v(p)),{click:()=>g(this),keydown:f=>{f.key==="Enter"&&g(this)}})))));m(this,Ye,l(()=>this.resize(),"#resizeHandler"));m(this,Ve,void 0);this.element().classList.add("selectionWindow"),h(this,Ve,c),this.resize(),window.addEventListener("resize",o(this,Ye))}close(){window.removeEventListener("resize",o(this,Ye)),super.close()}display(){return super.display(!1).then(()=>{let e=this.element().querySelector("select");e&&e.hasAttribute("autofocus")&&e.focus()})}resize(){var e,i;try{this.selectionList().style.maxHeight="none",this.selectionList().style.maxHeight=`calc(${this.element().offsetHeight-3-this.element().firstElementChild.offsetHeight-((i=(e=this.selectionList().previousElementSibling)==null?void 0:e.offsetHeight)!=null?i:0)-this.selectionList().nextElementSibling.offsetHeight}px - 2em)`}catch(r){console.warn(r)}}selectionList(){return o(this,Ve)}};l(ne,"SelectionWindow"),Ye=new WeakMap,Ve=new WeakMap;var oe=ne;var Et=class extends V{activate(){let t=new oe("Choose research",this.value().available.map(e=>({value:e._})),e=>{!e||(transport.send("action",{name:"ChooseResearch",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which advance would you like to research next?",{displayAll:!0})}build(){this.element().append(u('button.chooseResearch[title="Choose research"]'))}value(){return super.value()}};l(Et,"ChooseResearch");var Vi=Et;var Tt={Food:"Food",UnitSupportFood:"Food",PopulationSupportFood:"Food",Production:"Production",UnitSupportProduction:"Production",Trade:"Trade",Corruption:"Trade",Happiness:"Happiness",LuxuryHappiness:"Happiness",Unhappiness:"Unhappiness",MartialLawContent:"Unhappiness",MilitaryUnhappiness:"Unhappiness",PopulationUnhappiness:"Unhappiness",CityImprovementContent:"Unhappiness",Research:"Research",Luxuries:"Luxuries",Gold:"Gold",CityImprovementMaintenanceGold:"Gold"},se=Object.entries(Tt).reduce((a,[t,e])=>(Object.prototype.hasOwnProperty.call(a,e)||(a[e]=[]),a[e].push(t),a),{}),qi={Food:"city/food.png",Production:"city/production.png",Trade:"city/trade.png",Gold:"city/gold.png",Luxuries:"city/luxury.png",Pollution:"city/pollution.png",Research:"city/bulb.png",Unhappiness:"city/sad.png"};var Ki,Qi=l(a=>Ki=a,"setPreloadContainer"),Pi=l(a=>{let t=Ki.querySelector(`[src$="${a}.png"]`);return t===null?(console.error(`Missing image: ${a}.`),u("canvas")):t},"getPreloadedImage"),Si=Pi;var Nr=l((a,t,e)=>{let i=u("canvas"),r=i.getContext("2d");i.width=a.width,i.height=a.height,r.drawImage(a,0,0,a.width,a.height);let n=r.getImageData(0,0,i.width,i.height),s=l(p=>{var y;let g=null,f={r:0,g:0,b:0,a:0};return typeof p=="string"?(g=p.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i))!==null?f={r:parseInt(g[1],16),g:parseInt(g[2],16),b:parseInt(g[3],16),a:1}:(g=p.match(/^#([0-9a-fA-F])([0-9a-fA-F])([0-9a-fA-F])$/))!==null?f={r:parseInt(g[1]+g[1],16),g:parseInt(g[2]+g[2],16),b:parseInt(g[3]+g[3],16),a:1}:(g=p.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/))!==null?f={r:parseInt(g[1]),g:parseInt(g[2]),b:parseInt(g[3]),a:1}:(g=p.match(/^rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+|\d+\.|\.\d+|\d+\.\d+)\s*\)\s*$/))!==null&&(f={r:parseInt(g[1]),g:parseInt(g[2]),b:parseInt(g[3]),a:parseFloat((y=g[4])!=null?y:1)}):"length"in p&&(f={r:p[0]||0,g:p[1]||0,b:p[2]||0,a:p[3]||1}),f},"getColor"),d=t.map(s),c=e.map(s);for(let p=0;p<n.data.length;p+=4)d.forEach((g,f)=>{n.data[p]===g.r&&n.data[p+1]===g.g&&n.data[p+2]===g.b&&n.data[p+3]===g.a*255&&(n.data[p]=(c[f]||c[0]).r,n.data[p+1]=(c[f]||c[0]).g,n.data[p+2]=(c[f]||c[0]).b,n.data[p+3]=Math.trunc((c[f]||c[0]).a*255))});return r.putImageData(n,0,0),i},"replaceColours"),Ct=Nr;var ae,we,qe,le,Ke,de,j=class{constructor(t,e=2,i=16,r=u("canvas")){m(this,ae,void 0);m(this,we,void 0);m(this,qe,!0);m(this,le,void 0);m(this,Ke,void 0);m(this,de,void 0);h(this,ae,r),h(this,de,t),h(this,Ke,i),h(this,le,e),this.setCanvasSize(),h(this,we,o(this,ae).getContext("2d")),Qi(document.querySelector("#preload"))}canvas(){return o(this,ae)}clear(){this.context().clearRect(0,0,this.canvas().width,this.canvas().height)}context(){return o(this,we)}render(t=this.world().tiles()){this.clear(),t.forEach(({x:e,y:i})=>this.renderTile(this.world().get(e,i)))}renderTile({x:t,y:e}){let i=this.tileSize(),r=t*i,n=e*i;this.context().clearRect(r,n,i,i)}scale(){return o(this,le)}tileSize(){return o(this,Ke)*o(this,le)}update(t){t.forEach(({x:e,y:i})=>this.renderTile(this.world().get(e,i)))}world(){return o(this,de)}drawImage(t,e,i,r={}){var p,g;let n=this.tileSize(),s=e*n,d=i*n,c=this.getPreloadedImage(t);this.putImage(r.augment?r.augment(c):c,s+((p=r.offsetX)!=null?p:0),d+((g=r.offsetY)!=null?g:0))}filterNeighbours(t,e,i=["n","e","s","w"]){return i.filter(r=>e(o(this,de).getNeighbour(t,r)))}getPreloadedImage(t){return Pi(t)}putImage(t,e,i){o(this,we).imageSmoothingEnabled=!1,o(this,we).drawImage(t,e,i,t.width*o(this,le),t.height*o(this,le))}replaceColours(t,e,i){return Ct(t,e,i)}setCanvasSize(){o(this,ae).height=o(this,de).height()*this.tileSize(),o(this,ae).width=o(this,de).width()*this.tileSize()}isVisible(){return o(this,qe)}setVisible(t){h(this,qe,t)}};l(j,"Map"),ae=new WeakMap,we=new WeakMap,qe=new WeakMap,le=new WeakMap,Ke=new WeakMap,de=new WeakMap;var Ji=j;var Lt=class extends j{renderTile(t){super.renderTile(t);let{x:e,y:i}=t,r=this.tileSize(),n=e*r,s=i*r;if(t.city){let d=t.city,c=d.player,p=c.civilization,[g]=p.attributes.filter(f=>f.name==="colors");t.units.length>0&&(this.context().fillStyle="#000",this.context().fillRect(n,s,r,r)),this.context().fillStyle=g.value[0],this.context().fillRect(n+this.scale(),s+this.scale(),r-this.scale()*2,r-this.scale()*2),this.drawImage("map/city",e,i,{augment:f=>this.replaceColours(f,["#000"],[g.value[1]]),offsetX:this.scale(),offsetY:this.scale()})}}};l(Lt,"Cities");var Qe=Lt;var Mt=class extends re{constructor(t,e,i,r={}){var s,d;let n=M(u("button",v((s=r.okLabel)!=null?s:"OK")),{click:()=>{i(),this.close()},keydown:c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),c.stopPropagation(),i(),this.close())}});super(t,u("div.content",u("p",v(e)),u("footer",n,M(u("button",v((d=r.cancelLabel)!=null?d:"Cancel")),{click:()=>this.close(),keydown:c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),c.stopPropagation(),this.close())}}))),{...r,queue:!1}),n.focus()}};l(Mt,"ConfirmationWindow");var Zi=Mt;var Pe,Se,It=class{constructor(t,e){m(this,Pe,void 0);m(this,Se,[]);this.setIds(t),h(this,Pe,i=>{let{detail:r}=i,n=r.value.objects;!n||o(this,Se).some(s=>s in n)&&document.addEventListener("dataupdated",s=>e(s.detail.data),{once:!0})}),document.addEventListener("patchdatareceived",o(this,Pe))}dispose(){document.removeEventListener("patchdatareceived",o(this,Pe))}setIds(t){o(this,Se).splice(0,o(this,Se).length,...t)}};l(It,"DataObserver"),Pe=new WeakMap,Se=new WeakMap;var er=It;var Pt=class extends j{update(t){let e=[...t];return t.forEach(i=>{["n","ne","e","se","s","sw","w","nw"].forEach(r=>{let n=this.world().getNeighbour(i,r);e.includes(n)||e.push(n)})}),super.update(e)}};l(Pt,"TerrainAbstract");var D=Pt;var St=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t;t.terrain.features.length&&t.terrain.features.forEach(r=>r._==="Shield"?this.drawImage(`terrain/${r._.toLowerCase()}`,e,i,{offsetX:4*this.scale(),offsetY:4*this.scale()}):this.drawImage(`terrain/${r._.toLowerCase()}`,e,i))}};l(St,"Feature");var kt=St;var Ht=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t;this.filterNeighbours(t,r=>r.terrain._==="Unknown").forEach(r=>this.drawImage(`map/fog_${r}`,e,i))}};l(Ht,"Fog");var _t=Ht;var At=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t,r=t.improvements.reduce((n,s)=>{let d=s._;return d in n&&(n[d]=!0),n},{Mine:!1,Road:!1,Railroad:!1,Pollution:!1});if(["Mine","Pollution"].forEach(n=>{r[n]&&this.drawImage(`improvements/${n.toLowerCase()}`,e,i)}),r.Road){let n=this.filterNeighbours(t,d=>d.improvements.some(c=>c._==="Road"),["n","ne","e","se","s","sw","w","nw"]),s=this.filterNeighbours(t,d=>!!d.city||d.improvements.some(c=>c._==="Railroad"),["n","ne","e","se","s","sw","w","nw"]);if(n.forEach(d=>{(!r.Railroad||!s.includes(d))&&this.drawImage(`improvements/road_${d}`,e,i)}),r.Railroad&&s.forEach(d=>this.drawImage(`improvements/railroad_${d}`,e,i)),n.length===0&&s.length===0){let d=this.tileSize(),c=e*d,p=i*d,g=Math.floor(this.tileSize()/2)-this.scale();this.context().fillStyle=r.Railroad?"#000":"#8c5828",this.context().rect(c+g,p+g,this.scale()*2,this.scale()*2),this.context().fill()}}}};l(At,"Terrain");var Ot=At;var Ut=class extends oe{constructor(t,e=()=>{}){super("Activate unit",t.map(i=>{var r,n;return{label:i._+" ["+((n=(r=i.city)==null?void 0:r.name)!=null?n:"NONE")+"]"+(i.busy?` (${i.busy._})`:""),value:i.id}}),i=>{let[r]=t.filter(n=>n.id===i);if(!!r){if(!r.active){transport.send("action",{name:"InactiveUnit",id:i});return}e(r)}},null)}};l(Ut,"InactiveUnitSelectionWindow");var zt=Ut;var Dt=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t;!t.improvements.some(n=>n._==="Irrigation")||this.drawImage("improvements/irrigation",e,i)}};l(Dt,"Terrain");var Wt=Dt;var $t=class extends D{renderTile(t){super.renderTile(t);let{x:e,y:i}=t,r=this.tileSize(),n=e*r,s=i*r;if(t.terrain._!=="Unknown"){if(t.isLand)this.drawImage("terrain/land",e,i);else if(t.isWater&&(this.drawImage("terrain/ocean",e,i),t.isCoast)){let d=this.getPreloadedImage("terrain/coast_sprite"),c=(this.world().getNeighbour(t,"w").isLand?1:0)|(this.world().getNeighbour(t,"nw").isLand?2:0)|(this.world().getNeighbour(t,"n").isLand?4:0)|(this.world().getNeighbour(t,"ne").isLand?8:0)|(this.world().getNeighbour(t,"e").isLand?16:0)|(this.world().getNeighbour(t,"se").isLand?32:0)|(this.world().getNeighbour(t,"s").isLand?64:0)|(this.world().getNeighbour(t,"sw").isLand?128:0);if(c>0){let p=c&7,g=c>>2&7,f=c>>4&7,y=c>>6&7|(c&1)<<2,w=u('canvas[height="16"][width="16"]'),O=w.getContext("2d");O.drawImage(d,p<<4,0,8,8,0,0,8,8),O.drawImage(d,(g<<4)+8,0,8,8,8,0,8,8),O.drawImage(d,(f<<4)+8,8,8,8,8,8,8,8),O.drawImage(d,y<<4,8,8,8,0,8,8,8),this.putImage(w,n,s)}this.filterNeighbours(t,p=>p.terrain._==="River").forEach(p=>this.drawImage(`terrain/river_mouth_${p}`,e,i))}}}};l($t,"Land");var Je=$t;var rr=zr(ir());var Br={playerId:null,scale:2,tileSize:16},$,_,xe,B,et,Q,tt,A,Rt=class extends rr.EventEmitter{constructor(e,i=u("canvas"),r={playerId:null,scale:2},...n){let s={...Br,...r};super();m(this,$,void 0);m(this,_,{x:0,y:0});m(this,xe,void 0);m(this,B,[]);m(this,et,null);m(this,Q,void 0);m(this,tt,void 0);m(this,A,void 0);h(this,A,e),h(this,$,i),h(this,et,s.playerId),h(this,tt,s.tileSize),h(this,Q,s.scale),n.forEach(d=>o(this,B).push(new d(o(this,A),this.scale(),this.tileSize()))),h(this,xe,i.getContext("2d")),this.bindEvents()}bindEvents(){}build(e){o(this,B).forEach(i=>i.update(e))}canvas(){return o(this,$)}center(){return o(this,_)}getLayer(e){var i;return(i=this.getLayers(e).shift())!=null?i:null}getLayers(e){return o(this,B).filter(i=>i instanceof e)}isVisible(e,i){let[r,n,s,d]=this.visibleBounds();return(r>n?e<n||e>r:e<n&&e>r)&&(s>d?i<d||i>s:i<d&&i>s)}playerId(){return o(this,et)}render(){let e=o(this,B)[0].tileSize(),i=o(this,A).width()*e,r=o(this,_).x*e+Math.trunc(e/this.scale()),n=Math.trunc(o(this,$).width/2),s=o(this,A).height()*e,d=o(this,_).y*e+Math.trunc(e/this.scale()),c=Math.trunc(o(this,$).height/2),p=n-r,g=n+i,f=c-d,y=c+s;for(;p>0;)p-=i;for(;f>0;)f-=s;for(;g<o(this,$).width;)g+=i;for(;y<o(this,$).height;)y+=s;o(this,xe).fillStyle="#000",o(this,xe).fillRect(0,0,o(this,A).width()*e,o(this,A).height()*e);for(let w=p;w<g;w+=i)for(let O=f;O<y;O+=s)o(this,B).forEach(bi=>{if(!bi.isVisible())return;let fe=bi.canvas();o(this,xe).drawImage(fe,w,O,fe.width,fe.height)})}scale(){return o(this,Q)}setCenter(e,i){o(this,_).x=e,o(this,_).y=i,this.render(),this.emit("focus-changed",e,i)}tileSize(){return o(this,tt)}visibleBounds(){let e=Math.floor(o(this,$).width/o(this,B)[0].tileSize()/o(this,Q)),i=Math.floor(o(this,$).height/o(this,B)[0].tileSize()/o(this,Q)),r=(o(this,_).x-e+o(this,A).width())%o(this,A).width(),n=(o(this,_).x+e)%o(this,A).width(),s=(o(this,_).y-i+o(this,A).height())%o(this,A).height(),d=(o(this,_).y+i)%o(this,A).height();return[r,n,s,d]}visibleRange(){let e=Math.floor(o(this,$).width/o(this,B)[0].tileSize()/o(this,Q)),i=Math.floor(o(this,$).height/o(this,B)[0].tileSize()/o(this,Q));return[{x:o(this,_).x-e,y:o(this,_).y-i},{x:o(this,_).x+e,y:o(this,_).y+i}]}world(){return o(this,A)}};l(Rt,"Portal"),$=new WeakMap,_=new WeakMap,xe=new WeakMap,B=new WeakMap,et=new WeakMap,Q=new WeakMap,tt=new WeakMap,A=new WeakMap;var jt=Rt;var Bt=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t,r=this.filterNeighbours(t,n=>t.terrain._==="River"&&n.isWater||t.terrain._===n.terrain._).join("");t.terrain._!=="Ocean"&&(r?this.drawImage(`terrain/${t.terrain._.toLowerCase()}_${r}`,e,i):this.drawImage(`terrain/${t.terrain._.toLowerCase()}`,e,i))}};l(Bt,"Terrain");var Gt=Bt;var Xt,ke,ce,ue,pe,Ft=class{constructor(t){m(this,Xt,l((t,e)=>({_:"Tile",id:`Tile-${t}--${e}`,city:null,goodyHut:null,improvements:[],isCoast:!1,isLand:!1,isWater:!1,terrain:{_:"Unknown",id:`UnknownTerrain-${t}--${e}`,features:[]},units:[],x:t,y:e,yields:[]}),"#unknown"));m(this,ke,{});m(this,ce,void 0);m(this,ue,void 0);m(this,pe,void 0);h(this,ue,t.height),h(this,pe,t.width),h(this,ce,t.tiles||[])}get(t,e){for(;t<0;)t+=o(this,pe);for(;e<0;)e+=o(this,ue);for(;t>=o(this,pe);)t-=o(this,pe);for(;e>=o(this,ue);)e-=o(this,ue);let i=[t,e].toString();if(!(i in o(this,ke))){let r=o(this,ce).findIndex(n=>n.x===t&&n.y===e);if(r===-1)return o(this,Xt).call(this,t,e);o(this,ke)[i]=r}return o(this,ce)[o(this,ke)[i]]}getNeighbour(t,e){if(e==="n")return this.get(t.x,t.y-1);if(e==="ne")return this.get(t.x+1,t.y-1);if(e==="e")return this.get(t.x+1,t.y);if(e==="se")return this.get(t.x+1,t.y+1);if(e==="s")return this.get(t.x,t.y+1);if(e==="sw")return this.get(t.x-1,t.y+1);if(e==="w")return this.get(t.x-1,t.y);if(e==="nw")return this.get(t.x-1,t.y-1);throw new TypeError("Invalid direction.")}height(){return o(this,ue)}tiles(){return o(this,ce)}width(){return o(this,pe)}setTiles(t){h(this,ce,t)}};l(Ft,"World"),Xt=new WeakMap,ke=new WeakMap,ce=new WeakMap,ue=new WeakMap,pe=new WeakMap;var Yt=Ft;var Vt=class extends Ji{renderTile(t){super.renderTile(t);let{x:e,y:i}=t,r=this.tileSize(),n=e*r,s=i*r,d=t.yields.reduce((f,y)=>f+y.value,0),c=t.yields.sort((f,y)=>f._.charCodeAt(0)-y._.charCodeAt(0)),p=0;if(d<5){let f=[[n,s],[n+r/2,s],[n,s+r/2],[n+r/2,s+r/2]];c.forEach(y=>{for(let w=0;w<y.value;w++)this.putImage(this.getPreloadedImage(`city/${y._.toLowerCase()}`),...f[p++])});return}if(d<7){let f=[[n,s],[n+r/3,s],[n+r/3*2,s],[n,s+r/2],[n+r/3,s+r/2],[n+r/3*2,s+r/2]];c.forEach(y=>{for(let w=0;w<y.value;w++)this.putImage(this.getPreloadedImage(`city/${y._.toLowerCase()}`),f[p][0],f[p++][1])});return}if(d<9){let f=[[n,s],[n+r/4,s],[n+r/4*2,s],[n+r/4*3,s],[n,s+r/2],[n+r/4,s+r/2],[n+r/4*2,s+r/2],[n+r/4*3,s+r/2]];c.forEach(y=>{for(let w=0;w<y.value;w++)this.putImage(this.getPreloadedImage(`city/${y._.toLowerCase()}`),...f[p++])});return}if(d<11){let f=[[n,s],[n+r/5,s],[n+r/5*2,s],[n+r/5*3,s],[n+r/5*4,s],[n,s+r/2],[n+r/5,s+r/2],[n+r/5*2,s+r/2],[n+r/5*3,s+r/2],[n+r/5*4,s+r/2]];c.forEach(y=>{for(let w=0;w<y.value;w++)this.putImage(this.getPreloadedImage(`city/${y._.toLowerCase()}`),...f[p++])});return}let g=[[n,s],[n+r/6,s],[n+r/6*2,s],[n+r/6*3,s],[n+r/6*4,s],[n+r/6*5,s],[n,s+r/2],[n+r/6,s+r/2],[n+r/6*2,s+r/2],[n+r/6*3,s+r/2],[n+r/6*4,s+r/2],[n+r/6*5,s+r/2]];c.forEach(f=>{for(let y=0;y<f.value;y++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[p++])})}};l(Vt,"Yields");var He=Vt;var Gr={BuildingIrrigation:"I",BuildingMine:"M",BuildingRoad:"R",BuildingRailroad:"RR"},Fr=l((a,t=16)=>{var d,c;let e=a.player,i=e.civilization,[r]=i.attributes.filter(p=>p.name==="colors"),n=Ct(Si(`units/${a._.toLowerCase()}`),["#60E064","#2C7800"],r.value),s=n.getContext("2d");if(s.imageSmoothingEnabled=!1,(d=a.improvements)!=null&&d.some(p=>p._==="Fortified")&&s.drawImage(Si("map/fortify"),0,0),a.busy){let p=t/2,g=t*.75,f=(c=Gr[a.busy._])!=null?c:a.busy._.replace(/[a-z]+/g,"");s.font="bold 8px sans-serif",s.fillStyle="black",s.textAlign="center",s.fillText(f,p,g),s.fillStyle="white",s.fillText(f,p,g)}return n},"renderUnit"),qt=Fr;var it,Kt=class extends N{constructor(e,i=2){super(u('canvas[width="32"][height="32"]'));m(this,it,2);h(this,it,i),this.build(e)}build(e){let i=qt(e),r=this.element().getContext("2d");r.imageSmoothingEnabled=!1;let n=this.size(i.width),s=this.size(i.height),d=Math.floor((this.size(16)-n)/2),c=Math.floor((this.size(16)-s)/2);r.drawImage(i,d,c,n,s)}element(){return super.element()}size(e=16){return e*o(this,it)}};l(Kt,"Unit"),it=new WeakMap;var Hi=Kt;var Xr=l(a=>Math.max(1,Math.ceil((a.build.cost.value-a.build.progress.value)/a.yields.filter(t=>se.Production.includes(t._)).reduce((t,e)=>t+e.value,0))),"buildTurns"),Yr=l(a=>Math.max(1,Math.ceil((a.growth.cost.value-a.growth.progress.value)/a.yields.filter(t=>se.Food.includes(t._)).reduce((t,e)=>t+e.value,0))),"growthTurns"),Vr=l(a=>{let t=a.growth,e=parseInt(a.name.replace(/[^a-z]/gi,""),36).toString(2),[i,r]=a.yields.reduce(([d,c],p)=>(se.Happiness.includes(p._)&&(d+=p.value),se.Unhappiness.includes(p._)&&(c+=p.value),[d,c]),[0,0]),n=new Array(t.size).fill(1),s=n.length-1;for(;r>0&&s>-1;)n[s--]=0,r--;for(s=0;i>0&&s<n.length;)n[s]===0&&(n[s]++,i--),n[s]===1&&(n[s++]++,i--),n[s]===2&&s++;return u("div.population",...n.map((d,c)=>u("span.citizen",u(`img[src="view/assets/city/people_${["unhappy","content","happy"][d]}_${["f","m"][parseInt(e[c%e.length],10)]}.png"]`))))},"renderPopulation"),qr=l((a,t)=>t.filter(e=>se[a].includes(e._)).reduce(([e,i],r)=>[e+(r.value<0?-r.value:0),i+r.value],[0,0]),"reduceYield"),Kr=l(a=>u("div.yields-detail",...[["Food"],["Production"],["Trade"],["Luxuries","Gold","Research"]].map(t=>u(`div.yields[data-yields="${t.join(" ")}"]`,...t.map(e=>u(`span.yield[data-yield="${e}"]`,...qr(e,a.yields).map((i,r)=>u(`span.${["used","free"][r]}`,..._i({id:"",_:e,value:i,values:[]}))))))),...Object.entries(a.yields.filter(t=>!Object.keys(Tt).includes(t._)).reduce((t,e)=>(e._ in t||(t[e._]=0),t[e._]+=e.value,t),{})).map(([t,e])=>u("div",u("div",v(t)),u("div",v(e))))),"renderYields"),Qr=l((a,t)=>{let e=u("canvas"),i=new jt(new Yt(t.player.world),e,{playerId:t.player.id,scale:a.scale(),tileSize:a.tileSize()},Je,Wt,Gt,Ot,kt,_t,Qe,He);return e.height=a.tileSize()*a.scale()*5,e.width=a.tileSize()*a.scale()*5,i.setCenter(t.tile.x,t.tile.y),i.build(t.tiles),i.getLayer(He).render(t.tilesWorked),i.render(),M(u("div.city-map",e),{click:()=>transport.send("action",{name:"ReassignWorkers",city:t.id})})},"renderMap"),_i=l(a=>new Array(Math.abs(a.value)).fill(0).map(()=>u("span.yield-icon",u(`img[src="view/assets/${qi[Tt[a._]]}"]`))),"yieldImages"),Jr=l((a,t,e)=>{let i=Xr(a);return u("div.build",u("header",v(`Building ${a.build.building?a.build.building.item._:"nothing"}`)),M(u("button",v(a.build.building?"Change":"Choose")),{click(){t()}}),M(u("button",v("Buy")),{click(){e()}}),a.build.building?u("p",v(`Progress ${a.build.progress.value} / ${a.build.cost.value} (${i} turn${i===1?"":"s"})`)):v(""))},"renderBuildDetails"),Zr=l(a=>{let t=a.growth,e=Yr(a);return u("div.growth",u("header",v("Growth")),u("p",v(`Size ${t.size.toString()}`)),u("p",v(`Progress ${a.build.progress.value} / ${a.build.cost.value} (${e} turn${e===1?"":"s"})`)))},"renderGrowth"),en=l(a=>u("div.improvements",u("div",...a.improvements.map(t=>u("div",v(t._),...a.yields.filter(e=>e._==="CityImprovementMaintenanceGold").filter(e=>e.cityImprovement.id===t.id).flatMap(e=>_i(e)))))),"renderImprovements"),tn=l(a=>M(u("div.garrisoned-units",u("header",v("Garrisoned Units")),u("div.units",...a.tile.units.map(t=>new Hi(t).element()))),{click(){let t=a.tile.units.filter(e=>e.player.id===a.player.id);t.length!==0&&new zt(t)}}),"renderGarrisonedUnits"),rn=l(a=>u("div.supported-units",u("header",v("Supported Units")),u("div.units",...a.units.map(t=>u("span.unit",new Hi(t).element(),...a.yields.filter(e=>["UnitSupportFood","UnitSupportProduction","MilitaryUnhappiness"].includes(e._)).filter(e=>e.unit.id===t.id).flatMap(e=>_i(e)))))),"renderSupportedUnits"),nr=l((a,t,e,i)=>u("div.city-screen",u("div.top-row",u("div.yield-details",Vr(a),Kr(a),rn(a)),Qr(t,a),en(a)),u("div.bottom-row",Zr(a),u("div.tabbed-details",u("div.info",tn(a))),Jr(a,e,i))),"buildDetails"),J,_e,rt,Qt=class extends bt{constructor(e,i){super(e.name,nr(e,i,()=>this.changeProduction(),()=>this.completeProduction()),{size:"maximised"});m(this,J,void 0);m(this,_e,void 0);m(this,rt,void 0);this.element().classList.add("city-screen-window"),h(this,J,e),h(this,rt,i),h(this,_e,new er([e.id,e.build.id,e.growth.id,...e.units.map(r=>r.id)],r=>{var s,d;let[n]=((d=(s=r.player)==null?void 0:s.cities)!=null?d:[]).filter(c=>e.id===c.id);if(!n){this.close();return}h(this,J,n),o(this,_e).setIds([n.id,n.build.id,n.growth.id,...n.units.map(c=>c.id)]),this.update(nr(n,o(this,rt),()=>this.changeProduction(),()=>this.completeProduction())),this.element().focus()})),this.element().addEventListener("keydown",r=>{["c","C"].includes(r.key)&&(this.changeProduction(),r.preventDefault(),r.stopPropagation()),["b","B"].includes(r.key)&&(this.completeProduction(),r.preventDefault(),r.stopPropagation()),["Enter","x","X"].includes(r.key)&&this.close()})}changeProduction(){new Ae(o(this,J).build,()=>this.element().focus())}close(){o(this,_e).dispose(),super.close()}completeProduction(){!o(this,J).build.building||new Zi("Are you sure?",`Do you want to rush building of ${o(this,J).build.building.item._}`,()=>transport.send("action",{name:"CompleteProduction",id:o(this,J).id}))}};l(Qt,"City"),J=new WeakMap,_e=new WeakMap,rt=new WeakMap;var Jt=Qt;var Oe=class extends ne{constructor(e,i=()=>{},r={}){let n=e.city.yields.filter(d=>d._==="Production").reduce((d,c)=>d+c.value,0),s=l(d=>Math.ceil((d.cost.value-e.progress.value)/n),"turns");super(`What would you like to build in ${e.city.name}?`,e.available.map(d=>({label:`${d.item._} (Cost: ${d.cost.value} / ${s(d)} turn${s(d)===1?"":"s"})`,value:d.item._})),d=>{!d||(transport.send("action",{name:e.building===null?"CityBuild":"ChangeProduction",id:e.id,chosen:d||"@"}),this.close(!0))},null,{actions:r,displayAll:!0});this.onComplete=i}close(e=!1){super.close(),e&&this.onComplete(e)}};l(Oe,"CityBuildSelectionWindow"),Oe.showCityAction=l((e,i)=>({label:"View city",action(r){r.close(),new Jt(e,i)}}),"showCityAction"),Oe.showCityOnMapAction=l((e,i)=>({label:"Show on map",action(r){r.close(),i.setCenter(e.tile.x,e.tile.y)}}),"showCityOnMapAction");var Ae=Oe;var Ue,Zt=class extends V{constructor(e,i){super(e);m(this,Ue,void 0);h(this,Ue,i)}activate(){new Ae(this.value(),()=>this.complete(),{showCity:Ae.showCityAction(this.value().city,o(this,Ue)),showCityOnMap:Ae.showCityOnMapAction(this.value().city,o(this,Ue))})}build(){let e=this.value();this.element().append(u(`button.cityBuild[title="What would you like to build in ${e.city.name}?"]`))}value(){return super.value()}};l(Zt,"CityBuild"),Ue=new WeakMap;var or=Zt;var ei=class extends V{activate(){transport.send("action",{name:"EndTurn"})}build(){this.element().append(u('button.endTurn[title="End turn"]'))}};l(ei,"EndTurn");var sr=ei;var ti=class extends V{activate(){let t=new oe("Choose government",this.value().available.map(e=>({value:e._})),e=>{!e||(transport.send("action",{name:"Revolution",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which government would you like to convert to?",{displayAll:!0})}build(){this.element().append(u('button.chooseGovernment[title="Choose government"]'))}value(){return super.value()}};l(ti,"Revolution");var ar=ti;var nt,ii=class extends te{constructor(e=u("div.actions"),i){super(e);m(this,nt,void 0);h(this,nt,i),this.element().addEventListener("actioned",r=>r.detail.element().remove()),this.element().addEventListener("keydown",r=>{var g;let n=document.activeElement;if(!this.element().contains(n))return;let{key:s}=r,d=Array.from(this.element().children);if(!["ArrowDown","ArrowLeft","ArrowRight","ArrowUp"].includes(s)||d.length===0)return;r.preventDefault(),r.stopPropagation();let c=n===this.element()?["ArrowLeft","ArrowUp"].includes(s)?n.firstElementChild:n.lastElementChild:n;for(;c.parentElement!==this.element();)c=c.parentElement;let p=d.indexOf(c);if(["ArrowUp","ArrowLeft"].includes(s)){if(p>0){(g=d[p-1].querySelector("button"))==null||g.focus();return}d.pop().querySelector("button").focus();return}if(["ArrowDown","ArrowRight"].includes(s)){if(p<d.length-1){d[p+1].querySelector("button").focus();return}d.shift().querySelector("button").focus();return}},!0)}build(e){this.empty(),e.forEach(i=>{let r;switch(i._){case"ActiveUnit":return;case"AdjustTradeRates":r=new Yi(i);break;case"ChooseResearch":r=new Vi(i);break;case"CityBuild":r=new or(i,o(this,nt));break;case"EndTurn":r=new sr(i);break;case"Revolution":r=new ar(i);break;default:console.log("need to handle "+i._);return}this.element().prepend(M(r.element(),{click:()=>r.activate(),keydown:({key:n})=>{(n===" "||n==="Enter")&&r.activate()}}))})}};l(ii,"Actions"),nt=new WeakMap;var Ai=ii;var Ee,ri=class extends j{constructor(){super(...arguments);m(this,Ee,null)}renderTile(e){super.renderTile(e);let{x:i,y:r}=e,n=this.tileSize(),s=i*n,d=r*n;if(e.units.length>0&&(o(this,Ee)!==null?o(this,Ee).tile.id!==e.id:!0)){let[c]=e.units.sort((g,f)=>{var y,w;return((y=f.defence)==null?void 0:y.value)-((w=g.defence)==null?void 0:w.value)}),p=this.renderUnit(c);e.units.length>1&&this.putImage(p,s-this.scale(),d-this.scale()),this.putImage(p,s,d)}}renderUnit(e){return qt(e)}setActiveUnit(e){h(this,Ee,e)}activeUnit(){return o(this,Ee)}};l(ri,"Units"),Ee=new WeakMap;var ot=ri;var ni=class extends ot{render(){this.clear();let t=this.activeUnit();if(t===null)return;let{x:e,y:i}=t.tile,r=this.world().get(e,i),n=this.tileSize(),s=e*n,d=i*n,c=this.renderUnit(t);r.units.length>1&&this.putImage(c,s-this.scale(),d-this.scale()),this.putImage(c,s,d)}update(){this.render()}};l(ni,"ActiveUnit");var Oi=ni;var oi=class extends j{renderTile(t){if(!t.city)return;super.renderTile(t);let{x:e,y:i}=t,r=this.tileSize(),n=e*r,s=i*r,d=t.city,c=this.tileSize()/2,p=this.tileSize()*.75,g=this.tileSize()/2,f=this.tileSize()*1.6;this.context().font=`bold ${8*this.scale()}px sans-serif`,this.context().fillStyle="black",this.context().textAlign="center",this.context().fillText(d.growth.size.toString(),n+c+this.scale(),s+p),this.context().fillText(d.name,n+g+this.scale(),s+f),this.context().fillStyle="white",this.context().fillText(d.growth.size.toString(),n+c,s+p-this.scale()),this.context().fillText(d.name,n+g,s+f-this.scale())}update(){this.clear(),this.world().tiles().filter(t=>!!t.city).forEach(t=>this.renderTile(t))}};l(oi,"CityNames");var Ui=oi;var st,at,si=class extends N{constructor(e,i,r){super(e);m(this,st,void 0);m(this,at,void 0);h(this,st,i),h(this,at,r)}build(){this.empty(),this.element().append(u("h3",u("span#year",v(this.year())),u("span#turn",v(`(${o(this,st).value.toString()})`))))}year(e=o(this,at).value){return e<0?Math.abs(e)+" BCE":e===0?"1 CE":e+" CE"}};l(si,"GameDetails"),st=new WeakMap,at=new WeakMap;var lr=si;var ai=class extends jt{bindEvents(){this.canvas().addEventListener("click",t=>{let e=this.center(),i=t.offsetX,r=t.offsetY;for(i=(i-(this.canvas().width/2-this.tileSize()))/(this.tileSize()*this.scale())+e.x,r=(r-(this.canvas().height/2-this.tileSize()))/(this.tileSize()*this.scale())+e.y;i<0;)i+=this.world().width();for(;r<0;)r+=this.world().height();for(;i>this.world().width();)i-=this.world().width();for(;r>this.world().height();)r-=this.world().height();let n=this.world().get(Math.trunc(i),Math.trunc(r)),s=n.units.filter(d=>d.player.id===this.playerId());if(n.city)new Jt(n.city,this);else if(s.length){new zt(s,d=>this.emit("activate-unit",d));return}this.setCenter(n.x,n.y)})}};l(ai,"GamePortal");var dr=ai;var li=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t;t.goodyHut!==null&&this.drawImage("map/hut",e,i)}};l(li,"Terrain");var cr=li;var Te,me,di=class{constructor(t=500){m(this,Te,!1);m(this,me,[]);setInterval(()=>this.check(),t)}check(){o(this,Te)||o(this,me).forEach(t=>t())}clear(){h(this,me,[])}off(t){h(this,me,o(this,me).filter(e=>e!==t))}on(t){o(this,me).push(t)}pause(){h(this,Te,!0)}isPaused(){return o(this,Te)}resume(){h(this,Te,!1)}};l(di,"IntervalHandler"),Te=new WeakMap,me=new WeakMap;var ur=di;var ci=class extends ne{constructor(t,e,i,r="Please choose one of the following:",n={autoDisplay:!1,canClose:!1,displayAll:!1}){super(t,e,i,r,{...n,autoDisplay:!1,displayAll:!0})}display(){return new Promise(t=>{this.element().addEventListener("selection",({detail:e})=>t(e)),super.display()})}};l(ci,"MandatorySelection");var pr=ci;var ui=class extends N{constructor(t){super(t),this.build();let e=document.querySelector('#preload img[src$="main-menu-bg.jpg"]');e.loading?e.addEventListener("load",()=>{t.classList.add("active")}):t.classList.add("active")}build(t=!1){this.element().append(u("nav",M(u("button",v("Start a New Game")),{click:()=>{this.disableButtons(),[()=>new pr("How many players?",[{label:"7 civilizations",value:7},{label:"6 civilizations",value:6},{label:"5 civilizations",value:5},{label:"4 civilizations",value:4},{label:"3 civilizations",value:3}],i=>transport.send("setOption",{name:"players",value:i})).display()].reduce((e,i)=>e.then(()=>i()),Promise.resolve()).then(()=>{this.remove(),transport.send("start")})}}),M(u("button"+(t?"":"[hidden]"),v("Quit")),{click:()=>{this.remove(),transport.send("quit")}})))}disableButtons(){this.element().querySelectorAll("button").forEach(t=>t.setAttribute("disabled",""))}remove(){this.element().classList.remove("active"),setTimeout(()=>{this.element().remove()},2e3)}};l(ui,"MainMenu");var mr=ui;var G,X,Ce,ze,K,pi=class{constructor(t,e,i,...r){m(this,G,void 0);m(this,X,void 0);m(this,Ce,void 0);m(this,ze,void 0);m(this,K,void 0);h(this,X,t),h(this,K,e),h(this,ze,i),h(this,Ce,r),h(this,G,o(this,X).getContext("2d")),o(this,X).addEventListener("click",n=>{let s=n.offsetX-o(this,X).offsetLeft,d=n.offsetY-o(this,X).offsetTop,c=Math.ceil(s/o(this,X).offsetWidth*o(this,K).width()),p=Math.ceil(d/o(this,X).offsetHeight*o(this,K).height());o(this,ze).setCenter(c,p),this.update()})}update(){let t=o(this,Ce)[0].canvas().height*(190/o(this,Ce)[0].canvas().width);o(this,X).height=t,o(this,G).clearRect(0,0,190,t),o(this,Ce).forEach(r=>o(this,G).drawImage(r.canvas(),0,0,190,t));let[e,i]=o(this,ze).visibleRange();o(this,G).lineWidth=1,o(this,G).strokeStyle="#fff",o(this,G).fillStyle="rgba(255, 255, 255, .2)",o(this,G).rect(Math.floor(190/o(this,K).width()*e.x),Math.floor(t/o(this,K).height()*e.y),Math.floor(190/o(this,K).width()*(i.x-e.x)),Math.floor(t/o(this,K).height()*(i.y-e.y))),o(this,G).stroke(),o(this,G).fill()}};l(pi,"Minimap"),G=new WeakMap,X=new WeakMap,Ce=new WeakMap,ze=new WeakMap,K=new WeakMap;var hr=pi;var lt,De,mi=class{constructor(t=document.body){m(this,lt,void 0);m(this,De,[]);h(this,lt,t)}receive(t){o(this,De).push(t),this.check()}check(){let t=document.querySelector(".notificationWindow");if(!o(this,De).length||t)return;let e=o(this,De).shift();this.publish(e)}publish(t){var i;new xt((i=t.title)!=null?i:"Notification",t.message,{parent:o(this,lt)}).element().addEventListener("close",()=>this.check())}};l(mi,"Notifications"),lt=new WeakMap,De=new WeakMap;var fr=mi;var dt,hi=class extends N{constructor(e,i){super(e);m(this,dt,void 0);h(this,dt,i)}build(){this.empty();let{civilization:e,treasury:i,research:r,cities:n}=o(this,dt),[s,d]=n.reduce(([p,g],f)=>f.yields.reduce(([y,w],O)=>O._==="Research"?[y,w+O.value]:se.Gold.includes(O._)?[y+O.value,w]:[y,w],[p,g]),[0,0]),c=Math.ceil((r.cost.value-r.progress.value)/d);this.element().append(u("h3",v(`${e.leader.name} of the ${e._} empire`)),u("p",u("strong",v("Researching")),u("br"),v(r.researching?`${r.researching._} ${r.progress.value} / ${r.cost.value} (${c} turn${c===1?"":"s"})`:"Nothing")),u("p",u("strong",v("Treasury")),u("br"),v(`${i.value} (${s} / turn)`)))}};l(hi,"PlayerDetails"),dt=new WeakMap;var gr=hi;var L,fi=class extends N{constructor(e,i){super(e);m(this,L,void 0);h(this,L,i),this.build()}build(){var e,i;this.empty(),o(this,L)!==null&&this.element().append(u("p",v(`${o(this,L)._} (${o(this,L).tile.x}, ${o(this,L).tile.y})`)),u("p",v((i=(e=o(this,L).city)==null?void 0:e.name)!=null?i:"NONE")),u("p",v(`${Number.isInteger(o(this,L).moves.value)?o(this,L).moves.value:o(this,L).moves.value.toFixed(2)} / ${o(this,L).movement.value} moves`)),u("p",v(`A: ${o(this,L).attack.value} / D: ${o(this,L).defence.value} / V: ${o(this,L).visibility.value}`)),u("p",v(`${o(this,L).improvements.map(r=>r._).join(", ")}`)),u("p",v(`${o(this,L).tile.terrain._}${o(this,L).tile.terrain.features?" "+o(this,L).tile.terrain.features.map(r=>r._).join(", "):""}${o(this,L).tile.improvements.length?" ("+o(this,L).tile.improvements.map(r=>r._).join(", ")+")":""}`)),u("p",v(`${o(this,L).tile.units.filter(r=>r!==o(this,L)).map(r=>r._).join(", ")}`)))}};l(fi,"UnitDetails"),L=new WeakMap;var vr=fi;var ct,gi=class{constructor(t){m(this,ct,void 0);h(this,ct,t)}init(){let t=o(this,ct);window.transport=t;let e={autoEndOfTurn:!0};try{let i=document.getElementById("notification"),r=document.querySelector("#mainmenu"),n=document.getElementById("actions"),s=document.getElementById("other-actions"),d=document.getElementById("game"),c=document.getElementById("map"),p=c.querySelector("canvas"),g=document.getElementById("gameDetails"),f=document.getElementById("playerDetails"),y=document.getElementById("minimap"),w=document.getElementById("unitInfo"),O=new fr,bi=new mr(r),fe=l((T,S,Z,ge)=>{let Y=new vr(w,T);if(F=T,Y.build(),Z.setActiveUnit(T),Z.render(),Z.setVisible(!0),ge.setActiveUnit(T),ge.render(),ge.setVisible(!0),T===null){S.render();return}W=T,Z.update([...W!=null&&W.tile?[W.tile]:[],T.tile]),S.isVisible(T.tile.x,T.tile.y)||S.setCenter(T.tile.x,T.tile.y),S.render()},"setActiveUnit"),yi=[],ut,W=null,F=null;t.receive("notification",T=>{i.innerHTML=T,ut&&window.clearTimeout(ut),ut=window.setTimeout(()=>{ut=void 0,i.innerText=""},4e3)}),[["chooseCivilization","Choose your civilization"],["chooseLeader","Choose your leader"]].forEach(([T,S])=>t.receive(T,Z=>{let{choices:ge}=mt(Z);new oe(S,ge.map(({_:Y})=>({label:Y,value:Y})),Y=>t.send(T,Y),S,{displayAll:!0})})),console.log("binding once gameData"),t.receiveOnce("gameData",T=>{console.log("receiveOnce - gameData");try{let S=mt(T),Z=new Intl.ListFormat;new xt("Welcome",u("div.welcome",u("p",v(`${S.player.civilization.leader.name}, you have risen to become leader of the ${S.player.civilization._}.`)),u("p",v(`Your people have knowledge of ${Z.format(["Irrigation","Mining","Roads",...S.player.research.complete.map(b=>b._)])}`)))),d.classList.add("active"),p.width=p.parentElement.offsetWidth,p.height=p.parentElement.offsetHeight;let ge=2,Y=new Yt(S.player.world),pt=[],wr=new ur,C=new dr(Y,p,{playerId:S.player.id,scale:ge,tileSize:16},Je,Wt,Gt,Ot,kt,cr,_t,He,ot,Qe,Ui,Oi),xr=C.getLayer(Je),wi=C.getLayer(He),We=C.getLayer(ot),xi=C.getLayer(Qe),zi=C.getLayer(Ui),$e=C.getLayer(Oi);wi.setVisible(!1);let Ei=new hr(y,Y,C,xr,xi),Di=new Ai(n,C),Er=new Ai(s,C);C.on("focus-changed",()=>Ei.update()),C.on("activate-unit",b=>fe(b,C,We,$e)),wr.on(()=>{$e.setVisible(!$e.isVisible()),C.build(yi.splice(0)),C.render()}),window.addEventListener("resize",()=>{p.width=p.parentElement.offsetWidth,p.height=p.parentElement.offsetHeight});let Wi=1,Ti=!1,Ci=l(b=>{let E=Ti?[]:null,x=mt(b,E);E&&((P=>{for(let Ne=0,Ir=Math.ceil(P.length/1e3);Ne<Ir;Ne++)setTimeout(()=>P.slice(Ne*1e3,(Ne+1)*1e3-1).forEach(Pr=>delete b.objects[Pr]),(Ne+1)*200)})(E),Ti=!1),document.dispatchEvent(new CustomEvent("dataupdated",{detail:{data:x}})),Wi!==x.turn.value&&(Ti=!0,Wi=x.turn.value),Di.build(x.player.mandatoryActions),Er.build(x.player.actions.filter(P=>["AdjustTradeRates","Revolution"].includes(P._))),d.append(Di.element()),Y.setTiles(x.player.world.tiles),new lr(g,x.turn,x.year).build(),new gr(f,x.player).build(),pt=x.player.actions.filter(P=>P._==="ActiveUnit");let[k]=pt.sort(({value:P},{value:ee})=>ee===W?1:P===W?-1:(C.isVisible(ee.tile.x,ee.tile.y)?1:0)-(C.isVisible(P.tile.x,P.tile.y)?1:0));if(W!==(k==null?void 0:k.value)&&(W=null),fe(W!=null&&W.active?W:k?k.value:null,C,We,$e),C.build(yi.splice(0)),C.render(),Ei.update(),e.autoEndOfTurn&&x.player.mandatoryActions.length===1&&x.player.mandatoryActions.every(P=>P._==="EndTurn")){t.send("action",{name:"EndTurn"});return}},"handler");Ci(T),t.receive("gameData",b=>{console.log("gameData called again"),Ci(b)});let Tr=l(b=>b.replace(/]/g,"").split(/[.[]/),"pathToParts"),$i=l((b,E)=>{let x=Tr(E),I=x.pop();return[x.reduce((k,P)=>!k||!(P in k)?null:k[P],b),I]},"getPenultimateObject"),Cr=l((b,E,x)=>{let[I,z]=$i(b,E);if(!I||!z){console.warn(`unable to set ${E} of ${b} (${z})`);return}I[z]=x},"setObjectPath"),Lr=l((b,E)=>{let[x,I]=$i(b,E);if(!x||!I){console.warn(`unable to set ${E} of ${b} (${I})`);return}delete x[I]},"removeObjectPath");t.receive("gameDataPatch",b=>{b.forEach(E=>Object.entries(E).forEach(([x,{type:I,index:z,value:k}])=>{if(I==="add"||I==="update"){if(!k.hierarchy){console.error("No hierarchy"),console.error(k);return}z?Cr(T.objects[x],z,k.hierarchy):T.objects[x]=k.hierarchy,document.dispatchEvent(new CustomEvent("patchdatareceived",{detail:{value:k}})),Object.entries(k.objects).forEach(([P,ee])=>{T.objects[P]=ee,ee._==="PlayerTile"&&yi.push(ee)})}if(I==="remove"){if(z){Lr(T.objects[x],z);return}delete T.objects[x]}})),Ci(T)}),t.receive("gameNotification",b=>O.receive(b));let Ni={" ":["NoOrders"],b:["FoundCity"],D:["Disband"],f:["Fortify","BuildFortress"],i:["BuildIrrigation","ClearForest","ClearSwamp","ClearJungle"],m:["BuildMine","PlantForest"],P:["Pillage"],r:["BuildRoad","BuildRailroad"],s:["Sleep"],u:["Unload"],w:["Wait"]},Li={ArrowUp:"n",PageUp:"ne",ArrowRight:"e",PageDown:"se",ArrowDown:"s",End:"sw",ArrowLeft:"w",Home:"nw"},Mr={8:"n",9:"ne",6:"e",3:"se",2:"s",1:"sw",4:"w",7:"nw"},on={[KeyboardEvent.DOM_KEY_LOCATION_STANDARD]:Li,[KeyboardEvent.DOM_KEY_LOCATION_NUMPAD]:Mr},Ri="";document.addEventListener("keydown",b=>{if(F){if(b.key in Ni){let E=[...Ni[b.key]];for(;E.length;){let x=E.shift(),[I]=F.actions.filter(z=>z._===x);if(I){t.send("action",{name:"ActiveUnit",id:F.id,unitAction:I._,target:I.to.id}),b.stopPropagation(),b.preventDefault();return}}}if(b.key in Li){let[E]=F.actionsForNeighbours[Li[b.key]];if(E){t.send("action",{name:"ActiveUnit",id:F.id,unitAction:E._,target:E.to.id}),b.stopPropagation(),b.preventDefault();return}}}if(b.key==="Escape"&&document.activeElement!==null){document.activeElement.blur();return}if(b.key==="Enter"&&S.player.mandatoryActions.some(E=>E._==="EndOfTurn")){t.send("action",{name:"EndTurn"}),b.stopPropagation(),b.preventDefault();return}if(b.key==="Tab"){let E=n.querySelector("div.action:first-child button");if(E!==null){E.focus(),b.preventDefault(),b.stopPropagation();return}}if(b.key==="c"&&F){C.setCenter(F.tile.x,F.tile.y),C.render(),Ei.update();return}if(b.key==="w"&&F&&pt.length>1){let E=pt.map(z=>z.value),x=E.indexOf(F),I=E[x===E.length-1?0:x+1];fe(I,C,We,$e)}if(b.key==="t"){We.setVisible(!We.isVisible()),xi.setVisible(!xi.isVisible()),zi.setVisible(!zi.isVisible()),C.render();return}if(b.key==="y"){wi.setVisible(!wi.isVisible()),C.render();return}if(Ri==="%"&&b.key==="^"){t.send("cheat",{name:"RevealMap"});return}Ri=b.key})}catch(S){console.error(S)}})}catch(i){console.error(i)}}};l(gi,"Renderer"),ct=new WeakMap;var br=gi;var he,vi=class{constructor(t){m(this,he,void 0);h(this,he,t),t.addEventListener("message",({data:{channel:e,data:i}})=>console.log("receiving from backend: "+e,i))}receive(t,e){o(this,he).addEventListener("message",({data:{channel:i,data:r}})=>{i===t&&e(r)})}receiveOnce(t,e){let i=l(({data:{channel:r,data:n}})=>{r===t&&(e(n),o(this,he).removeEventListener("message",i))},"onceHandler");o(this,he).addEventListener("message",i)}send(t,e){console.log("sending to backend: "+t,e),o(this,he).postMessage({channel:t,data:e})}};l(vi,"WorkerTransport"),he=new WeakMap;var yr=vi;var nn=new br(new yr(new Worker("view/js/backend.js")));nn.init();})();
//# sourceMappingURL=frontend.js.map
